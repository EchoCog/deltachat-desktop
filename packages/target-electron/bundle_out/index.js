var Pi=Object.create;var Ht=Object.defineProperty;var Ii=Object.getOwnPropertyDescriptor;var Li=Object.getOwnPropertyNames;var Ai=Object.getPrototypeOf,Ni=Object.prototype.hasOwnProperty;var G=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Mi=(e,t)=>()=>(e&&(t=e(e=0)),t);var q=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Ri=(e,t)=>{for(var n in t)Ht(e,n,{get:t[n],enumerable:!0})},Wi=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Li(t))!Ni.call(e,o)&&o!==n&&Ht(e,o,{get:()=>t[o],enumerable:!(r=Ii(t,o))||r.enumerable});return e};var Te=(e,t,n)=>(n=e!=null?Pi(Ai(e)):{},Wi(t||!e||!e.__esModule?Ht(n,"default",{value:e,enumerable:!0}):n,e));import{createRequire as Fi}from"node:module";import $i from"node:path";import Bi from"node:url";var f=Mi(()=>{"use strict";globalThis.require=Fi(import.meta.url),globalThis.__filename=Bi.fileURLToPath(import.meta.url),globalThis.__dirname=$i.dirname(__filename)});var oo=q(we=>{f();we.parse=we.decode=ji,we.stringify=we.encode=eo,we.safe=De,we.unsafe=wt;var Vt=typeof process<"u"&&process.platform==="win32"?`\r
`:`
`;function eo(e,t){var n=[],r="";typeof t=="string"?t={section:t,whitespace:!1}:(t=t||{},t.whitespace=t.whitespace===!0);var o=t.whitespace?" = ":"=";return Object.keys(e).forEach(function(i,a,s){var c=e[i];c&&Array.isArray(c)?c.forEach(function(l){r+=De(i+"[]")+o+De(l)+`
`}):c&&typeof c=="object"?n.push(i):r+=De(i)+o+De(c)+Vt}),t.section&&r.length&&(r="["+De(t.section)+"]"+Vt+r),n.forEach(function(i,a,s){var c=to(i).join("\\."),l=(t.section?t.section+".":"")+c,u=eo(e[i],{section:l,whitespace:t.whitespace});r.length&&u.length&&(r+=Vt),r+=u}),r}function to(e){return e.replace(/\1/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map(function(t){return t.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"")})}function ji(e){var t={},n=t,r=null,o=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i,i=e.split(/[\r\n]+/g);return i.forEach(function(a,s,c){if(!(!a||a.match(/^\s*[;#]/))){var l=a.match(o);if(l){if(l[1]!==void 0){if(r=wt(l[1]),r==="__proto__"){n={};return}n=t[r]=t[r]||{};return}var u=wt(l[2]);if(u!=="__proto__"){var h=l[3]?wt(l[4]):!0;switch(h){case"true":case"false":case"null":h=JSON.parse(h)}if(u.length>2&&u.slice(-2)==="[]"){if(u=u.substring(0,u.length-2),u==="__proto__")return;n[u]?Array.isArray(n[u])||(n[u]=[n[u]]):n[u]=[]}Array.isArray(n[u])?n[u].push(h):n[u]=h}}}}),Object.keys(t).filter(function(a,s,c){if(!t[a]||typeof t[a]!="object"||Array.isArray(t[a]))return!1;var l=to(a),u=t,h=l.pop(),m=h.replace(/\\\./g,".");return l.forEach(function(g,w,D){g!=="__proto__"&&((!u[g]||typeof u[g]!="object")&&(u[g]={}),u=u[g])}),u===t&&m===h?!1:(u[m]=t[a],!0)}).forEach(function(a,s,c){delete t[a]}),t}function no(e){return e.charAt(0)==='"'&&e.slice(-1)==='"'||e.charAt(0)==="'"&&e.slice(-1)==="'"}function De(e){return typeof e!="string"||e.match(/[=\r\n]/)||e.match(/^\[/)||e.length>1&&no(e)||e!==e.trim()?JSON.stringify(e):e.replace(/;/g,"\\;").replace(/#/g,"\\#")}function wt(e,t){if(e=(e||"").trim(),no(e)){e.charAt(0)==="'"&&(e=e.substr(1,e.length-2));try{e=JSON.parse(e)}catch{}}else{for(var n=!1,r="",o=0,i=e.length;o<i;o++){var a=e.charAt(o);if(n)"\\;#".indexOf(a)!==-1?r+=a:r+="\\"+a,n=!1;else{if(";#".indexOf(a)!==-1)break;a==="\\"?n=!0:r+=a}}return n&&(r+="\\"),r.trim()}return e}});var ao=q((ac,io)=>{"use strict";f();var zt=1,ro=2;function Ui(){return""}function Hi(e,t,n){return e.slice(t,n).replace(/\S/g," ")}io.exports=function(e,t){t=t||{};for(var n,r,o=!1,i=!1,a=0,s="",c=t.whitespace===!1?Ui:Hi,l=0;l<e.length;l++){if(n=e[l],r=e[l+1],!i&&n==='"'){var u=e[l-1]==="\\"&&e[l-2]!=="\\";u||(o=!o)}if(!o){if(!i&&n+r==="//")s+=e.slice(a,l),a=l,i=zt,l++;else if(i===zt&&n+r===`\r
`){l++,i=!1,s+=c(e,a,l),a=l;continue}else if(i===zt&&n===`
`)i=!1,s+=c(e,a,l),a=l;else if(!i&&n+r==="/*"){s+=e.slice(a,l),a=l,i=ro,l++;continue}else if(i===ro&&n+r==="*/"){l++,i=!1,s+=c(e,a,l+1),a=l+1;continue}}}return s+(i?c(e.substr(a)):e.substr(a))}});var lo=q(ke=>{"use strict";f();var so=G("fs"),Vi=oo(),Ke=G("path"),zi=ao(),qi=ke.parse=function(e){return/^\s*{/.test(e)?JSON.parse(zi(e)):Vi.parse(e)},Gi=ke.file=function(){var e=[].slice.call(arguments).filter(function(o){return o!=null});for(var t in e)if(typeof e[t]!="string")return;var n=Ke.join.apply(null,e),r;try{return so.readFileSync(n,"utf-8")}catch{return}},lc=ke.json=function(){var e=Gi.apply(null,arguments);return e?qi(e):null},cc=ke.env=function(e,t){t=t||process.env;var n={},r=e.length;for(var o in t)if(o.toLowerCase().indexOf(e.toLowerCase())===0){for(var i=o.substring(r).split("__"),a;(a=i.indexOf(""))>-1;)i.splice(a,1);var s=n;i.forEach(function(l,u){!l||typeof s!="object"||(u===i.length-1&&(s[l]=t[o]),s[l]===void 0&&(s[l]={}),s=s[l])})}return n},uc=ke.find=function(){var e=Ke.join.apply(null,[].slice.call(arguments));function t(n,r){var o=Ke.join(n,r);try{return so.statSync(o),o}catch{if(Ke.dirname(n)!==n)return t(Ke.dirname(n),r)}}return t(process.cwd(),e)}});var ho=q((pc,mo)=>{"use strict";f();function co(e){return e instanceof Buffer||e instanceof Date||e instanceof RegExp}function uo(e){if(e instanceof Buffer){var t=Buffer.alloc?Buffer.alloc(e.length):new Buffer(e.length);return e.copy(t),t}else{if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e);throw new Error("Unexpected situation")}}function fo(e){var t=[];return e.forEach(function(n,r){typeof n=="object"&&n!==null?Array.isArray(n)?t[r]=fo(n):co(n)?t[r]=uo(n):t[r]=qt({},n):t[r]=n}),t}function po(e,t){return t==="__proto__"?void 0:e[t]}var qt=mo.exports=function(){if(arguments.length<1||typeof arguments[0]!="object")return!1;if(arguments.length<2)return arguments[0];var e=arguments[0],t=Array.prototype.slice.call(arguments,1),n,r,o;return t.forEach(function(i){typeof i!="object"||i===null||Array.isArray(i)||Object.keys(i).forEach(function(a){if(r=po(e,a),n=po(i,a),n!==e)if(typeof n!="object"||n===null){e[a]=n;return}else if(Array.isArray(n)){e[a]=fo(n);return}else if(co(n)){e[a]=uo(n);return}else if(typeof r!="object"||r===null||Array.isArray(r)){e[a]=qt({},n);return}else{e[a]=qt(r,n);return}})}),e}});var yo=q((hc,bo)=>{f();bo.exports=function(e,t){t||(t={});var n={bools:{},strings:{},unknownFn:null};typeof t.unknown=="function"&&(n.unknownFn=t.unknown),typeof t.boolean=="boolean"&&t.boolean?n.allBools=!0:[].concat(t.boolean).filter(Boolean).forEach(function(b){n.bools[b]=!0});var r={};Object.keys(t.alias||{}).forEach(function(b){r[b]=[].concat(t.alias[b]),r[b].forEach(function(C){r[C]=[b].concat(r[b].filter(function(L){return C!==L}))})}),[].concat(t.string).filter(Boolean).forEach(function(b){n.strings[b]=!0,r[b]&&(n.strings[r[b]]=!0)});var o=t.default||{},i={_:[]};Object.keys(n.bools).forEach(function(b){c(b,o[b]===void 0?!1:o[b])});var a=[];e.indexOf("--")!==-1&&(a=e.slice(e.indexOf("--")+1),e=e.slice(0,e.indexOf("--")));function s(b,C){return n.allBools&&/^--[^=]+$/.test(C)||n.strings[b]||n.bools[b]||r[b]}function c(b,C,L){if(!(L&&n.unknownFn&&!s(b,L)&&n.unknownFn(L)===!1)){var E=!n.strings[b]&&go(C)?Number(C):C;l(i,b.split("."),E),(r[b]||[]).forEach(function(X){l(i,X.split("."),E)})}}function l(b,C,L){for(var E=b,X=0;X<C.length-1;X++){var _=C[X];if(wo(E,_))return;E[_]===void 0&&(E[_]={}),(E[_]===Object.prototype||E[_]===Number.prototype||E[_]===String.prototype)&&(E[_]={}),E[_]===Array.prototype&&(E[_]=[]),E=E[_]}var _=C[C.length-1];wo(E,_)||((E===Object.prototype||E===Number.prototype||E===String.prototype)&&(E={}),E===Array.prototype&&(E=[]),E[_]===void 0||n.bools[_]||typeof E[_]=="boolean"?E[_]=L:Array.isArray(E[_])?E[_].push(L):E[_]=[E[_],L])}function u(b){return r[b].some(function(C){return n.bools[C]})}for(var h=0;h<e.length;h++){var m=e[h];if(/^--.+=/.test(m)){var g=m.match(/^--([^=]+)=([\s\S]*)$/),w=g[1],D=g[2];n.bools[w]&&(D=D!=="false"),c(w,D,m)}else if(/^--no-.+/.test(m)){var w=m.match(/^--no-(.+)/)[1];c(w,!1,m)}else if(/^--.+/.test(m)){var w=m.match(/^--(.+)/)[1],y=e[h+1];y!==void 0&&!/^-/.test(y)&&!n.bools[w]&&!n.allBools&&(!r[w]||!u(w))?(c(w,y,m),h++):/^(true|false)$/.test(y)?(c(w,y==="true",m),h++):c(w,n.strings[w]?"":!0,m)}else if(/^-[^-]+/.test(m)){for(var S=m.slice(1,-1).split(""),O=!1,T=0;T<S.length;T++){var y=m.slice(T+2);if(y==="-"){c(S[T],y,m);continue}if(/[A-Za-z]/.test(S[T])&&/=/.test(y)){c(S[T],y.split("=")[1],m),O=!0;break}if(/[A-Za-z]/.test(S[T])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(y)){c(S[T],y,m),O=!0;break}if(S[T+1]&&S[T+1].match(/\W/)){c(S[T],m.slice(T+2),m),O=!0;break}else c(S[T],n.strings[S[T]]?"":!0,m)}var w=m.slice(-1)[0];!O&&w!=="-"&&(e[h+1]&&!/^(-|--)[^-]/.test(e[h+1])&&!n.bools[w]&&(!r[w]||!u(w))?(c(w,e[h+1],m),h++):e[h+1]&&/^(true|false)$/.test(e[h+1])?(c(w,e[h+1]==="true",m),h++):c(w,n.strings[w]?"":!0,m))}else if((!n.unknownFn||n.unknownFn(m)!==!1)&&i._.push(n.strings._||!go(m)?m:Number(m)),t.stopEarly){i._.push.apply(i._,e.slice(h+1));break}}return Object.keys(o).forEach(function(b){Ji(i,b.split("."))||(l(i,b.split("."),o[b]),(r[b]||[]).forEach(function(C){l(i,C.split("."),o[b])}))}),t["--"]?(i["--"]=new Array,a.forEach(function(b){i["--"].push(b)})):a.forEach(function(b){i._.push(b)}),i};function Ji(e,t){var n=e;t.slice(0,-1).forEach(function(o){n=n[o]||{}});var r=t[t.length-1];return r in n}function go(e){return typeof e=="number"||/^0x[0-9a-f]+$/i.test(e)?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(e)}function wo(e,t){return t==="constructor"&&typeof e[t]=="function"||t==="__proto__"}});var Eo=q((wc,xo)=>{f();var Ye=lo(),Se=G("path").join,Ki=ho(),_o="/etc",vo=process.platform==="win32",Ze=vo?process.env.USERPROFILE:process.env.HOME;xo.exports=function(e,t,n,r){if(typeof e!="string")throw new Error("rc(name): name *must* be string");n||(n=yo()(process.argv.slice(2))),t=(typeof t=="string"?Ye.json(t):t)||{},r=r||Ye.parse;var o=Ye.env(e+"_"),i=[t],a=[];function s(c){if(!(a.indexOf(c)>=0)){var l=Ye.file(c);l&&(i.push(r(l)),a.push(c))}}return vo||[Se(_o,e,"config"),Se(_o,e+"rc")].forEach(s),Ze&&[Se(Ze,".config",e,"config"),Se(Ze,".config",e),Se(Ze,"."+e,"config"),Se(Ze,"."+e+"rc")].forEach(s),s(Ye.find("."+e+"rc")),o.config&&s(o.config),n.config&&s(n.config),Ki.apply(null,i.concat([o,n,a.length?{configs:a,config:a[a.length-1]}:void 0]))}});var Do=q((Gt,To)=>{f();(function(e,t){"use strict";typeof define=="function"&&define.amd?define("stackframe",[],t):typeof Gt=="object"?To.exports=t():e.StackFrame=t()})(Gt,function(){"use strict";function e(g){return!isNaN(parseFloat(g))&&isFinite(g)}function t(g){return g.charAt(0).toUpperCase()+g.substring(1)}function n(g){return function(){return this[g]}}var r=["isConstructor","isEval","isNative","isToplevel"],o=["columnNumber","lineNumber"],i=["fileName","functionName","source"],a=["args"],s=["evalOrigin"],c=r.concat(o,i,a,s);function l(g){if(g)for(var w=0;w<c.length;w++)g[c[w]]!==void 0&&this["set"+t(c[w])](g[c[w]])}l.prototype={getArgs:function(){return this.args},setArgs:function(g){if(Object.prototype.toString.call(g)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=g},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(g){if(g instanceof l)this.evalOrigin=g;else if(g instanceof Object)this.evalOrigin=new l(g);else throw new TypeError("Eval Origin must be an Object or StackFrame")},toString:function(){var g=this.getFileName()||"",w=this.getLineNumber()||"",D=this.getColumnNumber()||"",y=this.getFunctionName()||"";return this.getIsEval()?g?"[eval] ("+g+":"+w+":"+D+")":"[eval]:"+w+":"+D:y?y+" ("+g+":"+w+":"+D+")":g+":"+w+":"+D}},l.fromString=function(w){var D=w.indexOf("("),y=w.lastIndexOf(")"),S=w.substring(0,D),O=w.substring(D+1,y).split(","),T=w.substring(y+1);if(T.indexOf("@")===0)var b=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(T,""),C=b[1],L=b[2],E=b[3];return new l({functionName:S,args:O||void 0,fileName:C,lineNumber:L||void 0,columnNumber:E||void 0})};for(var u=0;u<r.length;u++)l.prototype["get"+t(r[u])]=n(r[u]),l.prototype["set"+t(r[u])]=function(g){return function(w){this[g]=!!w}}(r[u]);for(var h=0;h<o.length;h++)l.prototype["get"+t(o[h])]=n(o[h]),l.prototype["set"+t(o[h])]=function(g){return function(w){if(!e(w))throw new TypeError(g+" must be a Number");this[g]=Number(w)}}(o[h]);for(var m=0;m<i.length;m++)l.prototype["get"+t(i[m])]=n(i[m]),l.prototype["set"+t(i[m])]=function(g){return function(w){this[g]=String(w)}}(i[m]);return l})});var So=q((Jt,ko)=>{f();(function(e,t){"use strict";typeof define=="function"&&define.amd?define("error-stack-parser",["stackframe"],t):typeof Jt=="object"?ko.exports=t(Do()):e.ErrorStackParser=t(e.StackFrame)})(Jt,function(t){"use strict";var n=/(^|@)\S+:\d+/,r=/^\s*at .*(\S+:\d+|\(native\))/m,o=/^(eval@)?(\[native code])?$/;return{parse:function(a){if(typeof a.stacktrace<"u"||typeof a["opera#sourceloc"]<"u")return this.parseOpera(a);if(a.stack&&a.stack.match(r))return this.parseV8OrIE(a);if(a.stack)return this.parseFFOrSafari(a);throw new Error("Cannot parse given Error object")},extractLocation:function(a){if(a.indexOf(":")===-1)return[a];var s=/(.+?)(?::(\d+))?(?::(\d+))?$/,c=s.exec(a.replace(/[()]/g,""));return[c[1],c[2]||void 0,c[3]||void 0]},parseV8OrIE:function(a){var s=a.stack.split(`
`).filter(function(c){return!!c.match(r)},this);return s.map(function(c){c.indexOf("(eval ")>-1&&(c=c.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var l=c.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),u=l.match(/ (\(.+\)$)/);l=u?l.replace(u[0],""):l;var h=this.extractLocation(u?u[1]:l),m=u&&l||void 0,g=["eval","<anonymous>"].indexOf(h[0])>-1?void 0:h[0];return new t({functionName:m,fileName:g,lineNumber:h[1],columnNumber:h[2],source:c})},this)},parseFFOrSafari:function(a){var s=a.stack.split(`
`).filter(function(c){return!c.match(o)},this);return s.map(function(c){if(c.indexOf(" > eval")>-1&&(c=c.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),c.indexOf("@")===-1&&c.indexOf(":")===-1)return new t({functionName:c});var l=/((.*".+"[^@]*)?[^@]*)(?:@)/,u=c.match(l),h=u&&u[1]?u[1]:void 0,m=this.extractLocation(c.replace(l,""));return new t({functionName:h,fileName:m[0],lineNumber:m[1],columnNumber:m[2],source:c})},this)},parseOpera:function(a){return!a.stacktrace||a.message.indexOf(`
`)>-1&&a.message.split(`
`).length>a.stacktrace.split(`
`).length?this.parseOpera9(a):a.stack?this.parseOpera11(a):this.parseOpera10(a)},parseOpera9:function(a){for(var s=/Line (\d+).*script (?:in )?(\S+)/i,c=a.message.split(`
`),l=[],u=2,h=c.length;u<h;u+=2){var m=s.exec(c[u]);m&&l.push(new t({fileName:m[2],lineNumber:m[1],source:c[u]}))}return l},parseOpera10:function(a){for(var s=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,c=a.stacktrace.split(`
`),l=[],u=0,h=c.length;u<h;u+=2){var m=s.exec(c[u]);m&&l.push(new t({functionName:m[3]||void 0,fileName:m[2],lineNumber:m[1],source:c[u]}))}return l},parseOpera11:function(a){var s=a.stack.split(`
`).filter(function(c){return!!c.match(n)&&!c.match(/^Error created at/)},this);return s.map(function(c){var l=c.split("@"),u=this.extractLocation(l.pop()),h=l.shift()||"",m=h.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0,g;h.match(/\(([^)]*)\)/)&&(g=h.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var w=g===void 0||g==="[arguments not available]"?void 0:g.split(",");return new t({functionName:m,args:w,fileName:u[0],lineNumber:u[1],columnNumber:u[2],source:c})},this)}}})});var Mo=q((zc,sa)=>{sa.exports={name:"dotenv",version:"16.4.5",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard","lint-readme":"standard-markdown",pretest:"npm run lint && npm run dts-check",test:"tap tests/*.js --100 -Rspec","test:coverage":"tap --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@definitelytyped/dtslint":"^0.0.133","@types/node":"^18.11.3",decache:"^4.6.1",sinon:"^14.0.1",standard:"^17.0.0","standard-markdown":"^7.1.0","standard-version":"^9.5.0",tap:"^16.3.0",tar:"^6.1.11",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var $o=q((qc,se)=>{f();var en=G("fs"),tn=G("path"),la=G("os"),ca=G("crypto"),ua=Mo(),nn=ua.version,da=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function fa(e){let t={},n=e.toString();n=n.replace(/\r\n?/mg,`
`);let r;for(;(r=da.exec(n))!=null;){let o=r[1],i=r[2]||"";i=i.trim();let a=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),a==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),t[o]=i}return t}function pa(e){let t=Wo(e),n=W.configDotenv({path:t});if(!n.parsed){let a=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw a.code="MISSING_DATA",a}let r=Ro(e).split(","),o=r.length,i;for(let a=0;a<o;a++)try{let s=r[a].trim(),c=ga(n,s);i=W.decrypt(c.ciphertext,c.key);break}catch(s){if(a+1>=o)throw s}return W.parse(i)}function ma(e){console.log(`[dotenv@${nn}][INFO] ${e}`)}function ha(e){console.log(`[dotenv@${nn}][WARN] ${e}`)}function bt(e){console.log(`[dotenv@${nn}][DEBUG] ${e}`)}function Ro(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function ga(e,t){let n;try{n=new URL(t)}catch(s){if(s.code==="ERR_INVALID_URL"){let c=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw c.code="INVALID_DOTENV_KEY",c}throw s}let r=n.password;if(!r){let s=new Error("INVALID_DOTENV_KEY: Missing key part");throw s.code="INVALID_DOTENV_KEY",s}let o=n.searchParams.get("environment");if(!o){let s=new Error("INVALID_DOTENV_KEY: Missing environment part");throw s.code="INVALID_DOTENV_KEY",s}let i=`DOTENV_VAULT_${o.toUpperCase()}`,a=e.parsed[i];if(!a){let s=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);throw s.code="NOT_FOUND_DOTENV_ENVIRONMENT",s}return{ciphertext:a,key:r}}function Wo(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let n of e.path)en.existsSync(n)&&(t=n.endsWith(".vault")?n:`${n}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=tn.resolve(process.cwd(),".env.vault");return en.existsSync(t)?t:null}function Fo(e){return e[0]==="~"?tn.join(la.homedir(),e.slice(1)):e}function wa(e){ma("Loading env from encrypted .env.vault");let t=W._parseVault(e),n=process.env;return e&&e.processEnv!=null&&(n=e.processEnv),W.populate(n,t,e),{parsed:t}}function ba(e){let t=tn.resolve(process.cwd(),".env"),n="utf8",r=!!(e&&e.debug);e&&e.encoding?n=e.encoding:r&&bt("No encoding is specified. UTF-8 is used by default");let o=[t];if(e&&e.path)if(!Array.isArray(e.path))o=[Fo(e.path)];else{o=[];for(let c of e.path)o.push(Fo(c))}let i,a={};for(let c of o)try{let l=W.parse(en.readFileSync(c,{encoding:n}));W.populate(a,l,e)}catch(l){r&&bt(`Failed to load ${c} ${l.message}`),i=l}let s=process.env;return e&&e.processEnv!=null&&(s=e.processEnv),W.populate(s,a,e),i?{parsed:a,error:i}:{parsed:a}}function ya(e){if(Ro(e).length===0)return W.configDotenv(e);let t=Wo(e);return t?W._configVault(e):(ha(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),W.configDotenv(e))}function _a(e,t){let n=Buffer.from(t.slice(-64),"hex"),r=Buffer.from(e,"base64"),o=r.subarray(0,12),i=r.subarray(-16);r=r.subarray(12,-16);try{let a=ca.createDecipheriv("aes-256-gcm",n,o);return a.setAuthTag(i),`${a.update(r)}${a.final()}`}catch(a){let s=a instanceof RangeError,c=a.message==="Invalid key length",l=a.message==="Unsupported state or unable to authenticate data";if(s||c){let u=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw u.code="INVALID_DOTENV_KEY",u}else if(l){let u=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw u.code="DECRYPTION_FAILED",u}else throw a}}function va(e,t,n={}){let r=!!(n&&n.debug),o=!!(n&&n.override);if(typeof t!="object"){let i=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw i.code="OBJECT_REQUIRED",i}for(let i of Object.keys(t))Object.prototype.hasOwnProperty.call(e,i)?(o===!0&&(e[i]=t[i]),r&&bt(o===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):e[i]=t[i]}var W={configDotenv:ba,_configVault:wa,_parseVault:pa,config:ya,decrypt:_a,parse:fa,populate:va};se.exports.configDotenv=W.configDotenv,se.exports._configVault=W._configVault,se.exports._parseVault=W._parseVault,se.exports.config=W.config,se.exports.decrypt=W.decrypt,se.exports.parse=W.parse,se.exports.populate=W.populate,se.exports=W});var jo=q((Jc,Bo)=>{f();var xa=G("os"),Qe=G("path");function Ea(e){return Qe.join(process.env.HOME,"Library","Application Support",e)}function Ca(e){return process.env.XDG_CONFIG_HOME?Qe.join(process.env.XDG_CONFIG_HOME,e):Qe.join(process.env.HOME,".config",e)}function Ta(e){return process.env.LOCALAPPDATA?Qe.join(process.env.LOCALAPPDATA,e):Qe.join(process.env.USERPROFILE,"Local Settings","Application Data",e)}function Da(e){if(typeof e!="string")throw new TypeError("`name` must be string");switch(xa.platform()){case"darwin":return Ea(e);case"linux":return Ca(e);case"win32":return Ta(e)}throw new Error("Platform not supported")}Bo.exports=Da});var zo=q((Yc,Vo)=>{f();var et=G("path"),Uo=G("fs"),Ho=parseInt("0777",8);Vo.exports=Le.mkdirp=Le.mkdirP=Le;function Le(e,t,n,r){typeof t=="function"?(n=t,t={}):(!t||typeof t!="object")&&(t={mode:t});var o=t.mode,i=t.fs||Uo;o===void 0&&(o=Ho),r||(r=null);var a=n||function(){};e=et.resolve(e),i.mkdir(e,o,function(s){if(!s)return r=r||e,a(null,r);switch(s.code){case"ENOENT":if(et.dirname(e)===e)return a(s);Le(et.dirname(e),t,function(c,l){c?a(c,l):Le(e,t,a,l)});break;default:i.stat(e,function(c,l){c||!l.isDirectory()?a(s,r):a(null,r)});break}})}Le.sync=function e(t,n,r){(!n||typeof n!="object")&&(n={mode:n});var o=n.mode,i=n.fs||Uo;o===void 0&&(o=Ho),r||(r=null),t=et.resolve(t);try{i.mkdirSync(t,o),r=r||t}catch(s){switch(s.code){case"ENOENT":r=e(et.dirname(t),n,r),e(t,n,r);break;default:var a;try{a=i.statSync(t)}catch{throw s}if(!a.isDirectory())throw s;break}}return r}});var Go=q((Xc,qo)=>{f();var tt=G("fs"),yt=G("path"),ka=jo();function _t(e){this.filePath=yt.join(ka(e),"config.json")}_t.prototype.read=function(e){var t=this;tt.readFile(t.filePath,function(n,r){if(n&&n.code==="ENOENT")return e(null,{});if(n)return e(n);var o;try{o=JSON.parse(r.toString())}catch(i){return e(i)}e(null,o)})},_t.prototype.write=function(e,t){var n=this,r=zo();if(typeof e!="object"||e===null)throw new TypeError("data is not an object");var o=yt.dirname(n.filePath);r(o,function(i){if(i)return t(i);var a=n.filePath+"-"+Math.random().toString().substr(2)+Date.now().toString()+yt.extname(n.filePath);tt.writeFile(a,JSON.stringify(e,null,2),function(s){if(s)return t(s);tt.rename(a,n.filePath,t)})})},_t.prototype.trash=function(e){var t=this;tt.unlink(t.filePath,function(n){if(n&&n.code!=="ENOENT")return e(n);var r=yt.dirname(t.filePath);tt.rmdir(r,function(o){if(o&&o.code!=="ENOENT")return e(o);e(null)})})},qo.exports=function(t){return new _t(t)}});var an=q((cu,nr)=>{f();function rn(e,t,n){var r,o,i,a,s;t==null&&(t=100);function c(){var u=Date.now()-a;u<t&&u>=0?r=setTimeout(c,t-u):(r=null,n||(s=e.apply(i,o),i=o=null))}var l=function(){i=this,o=arguments,a=Date.now();var u=n&&!r;return r||(r=setTimeout(c,t)),u&&(s=e.apply(i,o),i=o=null),s};return l.clear=function(){r&&(clearTimeout(r),r=null)},l.flush=function(){r&&(s=e.apply(i,o),i=o=null,clearTimeout(r),r=null)},l}rn.debounce=rn,nr.exports=rn});f();f();var Co=Te(Eo(),1),Yi={"log-debug":!1,"log-to-console":!1,"machine-readable-stacktrace":!1,theme:void 0,devmode:!1,"translation-watch":!1,"theme-watch":!1,minimized:!1,version:!1,v:!1,help:!1,h:!1,"allow-unsafe-core-replacement":!1},te=(0,Co.default)("DeltaChat",Yi);(te.version||te.v)&&te.version==!0,(te.help||te.h)&&te.help==!0,te.devmode&&(te["log-debug"]=!0,te["log-to-console"]=!0);var Zi=Object.freeze(te),ne=Zi;f();f();f();var Qt=Te(So(),1),Xi=Date.now(),Oe=(e,t)=>n=>"\x1B["+e+";"+t+"m"+n+"\x1B[0m",Qi=Oe(1,34),Kt=Oe(1,31),ea=Oe(1,33),ta=Oe(0,37),kc=Oe(1,37),Sc=Oe(1,36),Oo='font-family: Roboto, "Apple Color Emoji", NotoEmoji, "Helvetica Neue", Arial, Helvetica, NotoMono, sans-serif !important;',na=(i=>(i.DEBUG="DEBUG",i.WARNING="WARNING",i.INFO="INFO",i.ERROR="ERROR",i.CRITICAL="CRITICAL",i))(na||{}),Yt=[{log:console.debug,level:"DEBUG",emoji:"\u{1F578}\uFE0F",symbol:"[D]"},{log:console.info,level:"INFO",emoji:"\u2139\uFE0F",symbol:Qi("[i]")},{log:console.warn,level:"WARNING",emoji:"\u26A0\uFE0F",symbol:ea("[w]")},{log:console.error,level:"ERROR",emoji:"\u{1F6A8}",symbol:Kt("[E]")},{log:console.error,level:"CRITICAL",emoji:"\u{1F6A8}\u{1F6A8}",symbol:Kt("[C]")}];function Oc(){console.info(`%cLogging Levels:
${Yt.map(e=>`${e.emoji} ${e.level}`).join(`
`)}`,Oo),console.info(`# Tips and Tricks for using the search filter in the browser console:

\u2022 Use space to separate search terms
\u2022 Exclude search terms using -
\u2022 If the search term contains spaces you should escape it with ""

Examples:

\u{1F578}\uFE0F          only show debug messages
-\u{1F578}\uFE0F         don't show debug messages
\u2139\uFE0F          only show info messages
-\u2139\uFE0F         don't show info messages
\u{1F47B}          only show events from background accounts (not selected accounts)
-\u{1F47B}         don't show events from background accounts (not selected accounts)
\u{1F4E1}          only show events
-\u{1F4E1}         don't show any events
[JSONRPC]   only show jsonrpc messages
-[JSONRPC]  don't show jsonrpc messages

Start deltachat with --devmode (or --log-debug and --log-to-console) argument to show full log output.
If the log seems quiet, make sure the 'All levels' drop down has 'Verbose' checked.
  `)}var Zt,Xe={};function Po(e,t){Zt=e,Xe=t}function Pe({channel:e,isMainProcess:t},n,r,o){let i=Yt[n];if(!Zt)throw console.log("Failed to log message - Handler not initialized yet"),console.log(`Log Message: ${e} ${n} ${o.join(" ")}`),Error("Failed to log message - Handler not initialized yet");if(Zt(e,i.level,r,...o),Xe["log-to-console"])if(t){let a=`${Math.round((Date.now()-Xi)/100)/10}s ${Yt[n].symbol}${ta(e)}:`;r?i.log(a,...o,Kt(Array.isArray(r)?r.map(s=>`
${s.toString()}`).join():r)):i.log(a,...o)}else{let a=`%c${i.emoji}%c${e}`,s=[Oo,"color:blueviolet;"];r?i.log(a,...s,r,...o):i.log(a,...s,...o)}}function Pc(){let e=Qt.default.parse(new Error("Get Stacktrace")),t=e.slice(2,e.length);return Xe["machine-readable-stacktrace"]?t:t.map(n=>`
${n.toString()}`).join()}var Xt=class{constructor(t){this.channel=t;this.isMainProcess=typeof window>"u";t==="core/event"&&(this.getStackTrace=()=>"")}getStackTrace(){let t=Qt.default.parse(new Error("Get Stacktrace")),n=t.slice(2,t.length);return Xe["machine-readable-stacktrace"]?n:n.map(r=>`
${r.toString()}`).join()}debug(...t){Xe["log-debug"]&&Pe(this,0,"",t)}info(...t){Pe(this,1,"",t)}warn(...t){Pe(this,2,this.getStackTrace(),t)}error(...t){Pe(this,3,this.getStackTrace(),t)}errorWithoutStackTrace(...t){Pe(this,3,[],t)}critical(...t){Pe(this,4,this.getStackTrace(),t)}};function x(e){return new Xt(e)}"toJSON"in Error.prototype||Object.defineProperty(Error.prototype,"toJSON",{value:function(){let e={};return Object.getOwnPropertyNames(this).forEach(function(t){e[t]=this[t]},this),e},configurable:!0,writable:!0});f();var Ie=x("localize");function Io(e,t){let n=e.replace("_","-"),r;try{r=new Intl.PluralRules(n)}catch(i){Ie.errorWithoutStackTrace(i),r=new Intl.PluralRules("en")}function o(i,a,s){let c=i,l={};typeof s=="string"?l={quantity:s}:l=Object.assign({},s);let u=t[c];if(!u)return Ie.error(`Missing translation for key '${c}'`),c;let h=u.message;if(typeof l.quantity<"u"&&(typeof l.quantity=="string"?h=u[l.quantity]:typeof l.quantity=="number"?h=u[l.quantity]||u[r.select(l.quantity)]||u.other:h=void 0,typeof h>"u"))return Ie.error(`Missing quantity '${l.quantity}' for key '${c}'`),`${c}:${l.quantity}`;if(typeof h>"u")return Ie.error(`Missing 'message' for key '${c}', maybe you need to specify quantity`),`${c}:?`;if(a){Array.isArray(a)||(a=[a]);let m=-1;return h.replace(/(?:%\d\$[\w\d])|(?:%[\w\d])/g,g=>{if(m++,g.length>2){let w=Number.parseInt(g[1])-1;return a===void 0||typeof a[w]>"u"?(Ie.error(`Missing ${w} argument for key %c'${c}'`),""):a[w].toString()}return a===void 0||typeof a?.[m]>"u"?(Ie.error(`Missing 0 argument for key %c'${c}'`),""):a[m].toString()})}return h}return o}f();f();var oa="Delta Chat",Ao="https://delta.chat",Lo="https://github.com/deltachat/deltachat-desktop",No=Lo+"/issues",Fc=Lo+"/blob/main/LICENSE",$c="https://delta.chat/donate",ce=oa,ra=(s=>(s[s.ZERO_SECONDS=0]="ZERO_SECONDS",s[s.ONE_SECOND=1]="ONE_SECOND",s[s.ONE_MINUTE_IN_SECONDS=60]="ONE_MINUTE_IN_SECONDS",s[s.ONE_HOUR_IN_SECONDS=3600]="ONE_HOUR_IN_SECONDS",s[s.ONE_DAY_IN_SECONDS=86400]="ONE_DAY_IN_SECONDS",s[s.ONE_WEEK_IN_SECONDS=604800]="ONE_WEEK_IN_SECONDS",s[s.ONE_YEAR_IN_SECONDS=31536e3]="ONE_YEAR_IN_SECONDS",s))(ra||{}),ia=(c=>(c[c.NEVER=0]="NEVER",c[c.AT_ONCE=1]="AT_ONCE",c[c.ONE_MINUTE=60]="ONE_MINUTE",c[c.ONE_HOUR=3600]="ONE_HOUR",c[c.ONE_DAY=86400]="ONE_DAY",c[c.ONE_WEEK=604800]="ONE_WEEK",c[c.FIVE_WEEKS=3024e3]="FIVE_WEEKS",c[c.ONE_YEAR=31536e3]="ONE_YEAR",c))(ia||{}),Bc=["jpg","jpeg","png","apng","gif","webp"],jc="https://meet.systemli.org/$ROOM",Uc="https://vc.autistici.org/$ROOM",aa=(r=>(r[r.MESSAGE=0]="MESSAGE",r[r.REACTION=1]="REACTION",r[r.WEBXDC_INFO=2]="WEBXDC_INFO",r))(aa||{});f();f();var Ko=Te(Go(),1);if(process.env.NODE_ENV!=="production")try{let{config:e}=await Promise.resolve().then(()=>Te($o(),1));e()}catch(e){console.error("Failed to load .env file",e)}var on=(0,Ko.default)("DeltaChat");import{join as Jo}from"path";process.env.DC_TEST_DIR?on.filePath=Jo(process.env.DC_TEST_DIR,"config.json"):process.env.PORTABLE_EXECUTABLE_DIR&&(console.log("Running in Portable Mode",process.env.PORTABLE_EXECUTABLE_DIR),on.filePath=Jo(process.env.PORTABLE_EXECUTABLE_DIR,"DeltaChatData","config.json"));var Ae=Object.freeze(on);import{dirname as Yo,join as oe}from"path";import{app as Sa,screen as Oa}from"electron";import{fileURLToPath as Pa}from"url";var Ia=Yo(Pa(import.meta.url)),Zo=oe(Ia,"..");function ue(){let e=process.platform==="win32"?".ico":".png";return`${oe(A(),"images","deltachat"+e)}`}function A(){return oe(Zo,"html-dist")}function Xo(){let e="main.html",t=1e3;process.env.NODE_ENV==="test"&&(e="test.html",t=1100);let{height:n,width:r}=Oa.getPrimaryDisplay().workAreaSize,o=38,i=Math.min(802+o,n),a=(r-t)/2,s=(n-i)/2;return{bounds:{height:i,width:t,x:a,y:s},headerHeight:o,minWidth:225,minHeight:125,main:e,preload:oe(A(),"preload.js")}}function J(){return Yo(Ae.filePath)}function K(){return oe(J(),"logs")}function be(){return oe(J(),"accounts")}function nt(){return oe(J(),"custom-themes")}function de(){return oe(Sa.getPath("temp"),"chat.delta.desktop-draft")}var Qo=["OPENPGP4FPR:","MAILTO:","DCACCOUNT:","DCLOGIN:"],La=["images","node_modules","html-dist"],Aa=["src","scss","node_modules"],Na=["background"],er=[...[...La,...Aa].map(e=>oe(Zo,e)),...Na.map(e=>oe(J(),e)),de()],tr=["db.sqlite-blobs","dc.db-blobs","stickers"],vt="tmp";var Q={};Ri(Q,{chooseLanguage:()=>at,hide:()=>es,init:()=>mn,isAlwaysOnTop:()=>gn,send:()=>$,setBounds:()=>ts,setProgress:()=>ns,setTitle:()=>os,setZoomFactor:()=>wn,show:()=>rt,toggleAlwaysOnTop:()=>hn,toggleDevTools:()=>it,window:()=>d});f();f();f();f();function or(){return{bounds:{},HTMLEmailWindowBounds:void 0,enterKeySends:!1,notifications:!0,showNotificationContent:!0,locale:null,credentials:void 0,lastAccount:void 0,enableAVCalls:!1,enableBroadcastLists:!1,enableChatAuditLog:!1,enableOnDemandLocationStreaming:!1,chatViewBgImg:void 0,lastChats:{},zoomFactor:1,activeTheme:"system",minimizeToTray:!0,syncAllAccounts:!0,lastSaveDialogLocation:void 0,experimentalEnableMarkdownInMessages:!1,enableWebxdcDevTools:!1,HTMLEmailAskForRemoteLoadingConfirmation:!0,HTMLEmailAlwaysLoadRemoteContent:!1,enableRelatedChats:!1,galleryImageKeepAspectRatio:!1,useSystemUIFont:!1,contentProtectionEnabled:!1,isMentionsEnabled:!0,autostart:!0}}var rr=Te(an(),1);import{EventEmitter as Ma}from"events";import{promisify as Ra}from"util";var xt=x("main/state"),Wa=1e3,sn=class extends Ma{constructor(){super()}inner_state=null;get state(){if(this.inner_state==null)throw new Error("Can not access persistent state before initialisation");return this.inner_state}async load(){let t=or(),n={};try{n=await Ra(r=>Ae.read(r))(),(typeof n.lastAccount!="number"||n.lastAccount<0)&&(n.lastAccount=void 0)}catch(r){xt.debug(r),xt.info("Missing configuration file. Using default values.")}this.inner_state=Object.assign(t,n)}update(t){this.inner_state={...this.inner_state,...t},this.save()}save(){this.save=(0,rr.default)(this.saveImmediate,Wa),this.saveImmediate()}saveImmediate(){xt.info(`Saving state to ${Ae.filePath}`);let t=Object.assign({},this.inner_state);return new Promise((n,r)=>{Ae.write(t,o=>{o&&(xt.error("State save failed",o),r(o)),n(o)})})}},v=new sn;import{app as Fa,Menu as ir,Tray as $a,nativeImage as Ba}from"electron";import{globalShortcut as ja}from"electron";import{join as ln,dirname as Ua}from"path";import{fileURLToPath as Ha}from"url";var Mu=Ua(Ha(import.meta.url)),R=null,cn=null,ar=Fa,un=x("main/tray"),sr=!1;function ur(e){sr=e,R&&R.setImage(lr())}function lr(){let e=ln(A(),"images/tray");if(process.platform==="darwin"){let t=Ba.createFromPath(ln(e,"tray-icon-mac.png")).resize({width:24});return t.setTemplateImage(!0),t}else{let t=process.platform==="win32"?".ico":".png";return`${ln(e,(sr?"deltachat-unread":"deltachat")+t)}`}}function dn(){if(!d)throw new Error("window does not exist, this should never happen");return process.platform==="darwin"||process.platform==="win32"?d.isVisible():d.isVisible()&&d.isFocused()}function Ne(e){if(!d)throw new Error("window does not exist, this should never happen");e===!0&&d.minimize(),d.hide(),process.platform==="linux"&&R?.setContextMenu(ot())}function ye(){if(!d)throw new Error("window does not exist, this should never happen");d.show()}function fn(){dn()?Ne(!0):ye()}function Et(){ja.unregisterAll(),ar.quit()}function Ct(){if(!ar.rc.minimized&&v.state.minimizeToTray!==!0){R!=null&&cr();return}za()}function cr(){un.info("destroy icon tray"),R?.destroy(),R=null}function ot(){if(R!==null)return process.platform==="darwin"?cn=ir.buildFromTemplate([dn()?{id:"reduce_window",label:p("hide"),type:"normal",click(){Ne(),Me()}}:{id:"open_windows",label:p("activate"),type:"normal",click(){ye(),Me()}},{id:"quit_app",label:p("global_menu_file_quit_desktop"),type:"normal",click(){Et()}}]):cn=ir.buildFromTemplate([{id:"open_windows",label:p("global_menu_file_open_desktop"),type:"normal",click(){ye()}},{id:"reduce_window",label:p("global_menu_minimize_to_tray"),type:"normal",enabled:dn(),click(){Ne()}},{id:"quit_app",label:p("global_menu_file_quit_desktop"),type:"normal",click(){Et()}}]),cn}function Va(){return new $a(lr())}function za(){R!=null&&(un.warn("Tray icon not destroyed before render?"),cr()),un.info("add icon tray"),R=Va(),R.setToolTip("Delta Chat"),process.platform==="darwin"?(R.on("click",()=>R?.popUpContextMenu(ot())),R.on("right-click",()=>R?.popUpContextMenu(ot()))):process.platform==="win32"?(R.on("click",fn),R.on("right-click",()=>R?.popUpContextMenu(ot()))):(R.on("click",fn),R.on("double-click",fn),Me())}function Me(){R?.setContextMenu(ot())}f();import{screen as _e}from"electron";function Re(e,t,n){let r=()=>{let{workAreaSize:o}=_e.getPrimaryDisplay();o.width*.75<t||o.height*.75<n?e.setMinimumSize(0,0):e.setMinimumSize(t,n)};return _e.addListener("display-added",r),_e.addListener("display-metrics-changed",r),_e.addListener("display-removed",r),r(),()=>{_e.removeListener("display-added",r),_e.removeListener("display-metrics-changed",r),_e.removeListener("display-removed",r)}}f();import{BrowserWindow as qa}from"electron";import{platform as pn}from"os";var Ga=x("contentProtection");function dr(e,t){e.setContentProtection(t),t&&pn()!=="darwin"&&pn()!=="win32"&&Ga.warn("setContentProtection not available on your platform",pn())}function fe(e){dr(e,v.state.contentProtectionEnabled)}function fr(e){for(let t of qa.getAllWindows())dr(t,e)}var mr=Te(an(),1);import pr,{session as Ja}from"electron";import{isAbsolute as Ka,join as Ya,sep as Za}from"path";import{platform as Xa}from"os";import{fileURLToPath as Qa}from"url";var V=x("/mainWindow"),d=null;function mn(e){if(d)return d.show();let t=Xo(),n=Object.assign(t.bounds,v.state.bounds),r=Xa()==="darwin",o=d=new pr.BrowserWindow({backgroundColor:"#282828",darkTheme:!0,icon:ue(),show:!1,title:ce,height:n.height,width:n.width,x:n.x,y:n.y,webPreferences:{nodeIntegration:!1,preload:t.preload,spellcheck:!1,webSecurity:!0,allowRunningInsecureContent:!1,contextIsolation:!1},titleBarStyle:r?"hidden":"default",titleBarOverlay:!0});o.filePathWhiteList=[],Re(o,t.minWidth,t.minHeight),fe(d),Ja.defaultSession.setSpellCheckerDictionaryDownloadURL("https://00.00/"),d.loadFile(Ya(A(),t.main)),d.once("ready-to-show",()=>{e.hidden||o.show(),process.env.NODE_ENV==="test"&&o.maximize()}),d.setSheetOffset&&d.setSheetOffset(t.headerHeight),d.webContents.on("will-navigate",(c,l)=>{c.preventDefault()});let i=(0,mr.default)(()=>{let c=d?.getBounds();c&&v.update({bounds:c})},1e3);d.on("move",i),d.on("resize",i),d.once("show",()=>{o.webContents.setZoomFactor(v.state.zoomFactor)}),d.on("close",()=>{}),d.on("blur",()=>{o.hidden=!0,Me()}),d.on("focus",()=>{o.hidden=!1,Me(),Y()});let a=["notifications","pointerLock","fullscreen","clipboard-read","media","mediaKeySystem","accessibility-events","clipboard-sanitized-write"],s=c=>(V.info("preq",c),a.includes(c)?!0:(V.info(`main window requested "${c}" permission, but we denied it, because it is not in the list of allowed permissions.`),!1));d.webContents.session.setPermissionCheckHandler((c,l)=>s(l)),d.webContents.session.setPermissionRequestHandler((c,l,u)=>{u(s(l))}),d.webContents.session.webRequest.onBeforeRequest({urls:["file://*"]},(c,l)=>{let u=Qa(decodeURIComponent(new URL(c.url).href));if(!Ka(u)||u.includes(".."))return V.errorWithoutStackTrace("tried to access relative path",u),l({cancel:!0});if(u.startsWith(be())){let h=u.replace(be(),""),m=h.slice(h.indexOf(Za,1)+1);if(tr.find(g=>m.startsWith(g)))return l({cancel:!1})}return er.find(h=>u.startsWith(h))?l({cancel:!1}):d?.filePathWhiteList.includes(u)?l({cancel:!1}):(V.errorWithoutStackTrace("tried to access path that is not whitelisted",u),l({cancel:!0}))})}function es(){d?.hide()}function $(e,...t){if(!d){V.warn("window not defined, can't send ipc to renderer");return}if(d.isDestroyed()){V.info("window is destroyed. not sending message",t);return}try{d.webContents.send(e,...t)}catch(n){V.error("can not send message to window, error:",n)}}function ts(e,t){if(!d)throw new Error("window does not exist, this should never happen");if(t===!0&&!d.isMaximized()?(V.debug("setBounds: maximizing"),d.maximize()):t===!1&&d.isMaximized()&&(V.debug("setBounds: unmaximizing"),d.unmaximize()),typeof t=="boolean"?t:d.isMaximized())V.debug("setBounds: not setting bounds because of window maximization");else{if(V.debug(`setBounds: setting bounds to ${JSON.stringify(e)}`),e.x===null&&e.y===null){let r=pr.screen.getDisplayMatching(d.getBounds());e.x=Math.round(r.bounds.x+r.bounds.width/2-e.width/2),e.y=Math.round(r.bounds.y+r.bounds.height/2-e.height/2),V.debug(`setBounds: centered to ${JSON.stringify(e)}`)}e.contentBounds?d.setContentBounds(e,!0):d.setBounds(e,!0)}}function ns(e){d?.setProgressBar(e)}function os(e){e?d?.setTitle(`${ce} - ${e}`):d?.setTitle(ce)}function rt(){d?.show()}function hn(){if(!d)return;let e=!d.isAlwaysOnTop();V.info(`toggleAlwaysOnTop ${e}`),d.setAlwaysOnTop(e)}function gn(){return d?d.isAlwaysOnTop():!1}function it(){d&&(V.info("toggleDevTools"),d.webContents.isDevToolsOpened()?d.webContents.closeDevTools():d.webContents.openDevTools({mode:"detach"}))}function at(e){d?.webContents.send("chooseLanguage",e)}function wn(e){V.info("setZoomFactor",e),d?.webContents.setZoomFactor(e)}f();import{platform as rs}from"os";import{join as hr}from"path";import{app as is}from"electron";import{readFile as as}from"fs/promises";import{existsSync as ss}from"fs";var Tt=!1;async function gr(){if(rs()==="win32"){let e=is.getAppPath();try{let t=JSON.parse(await as(hr(e,"../../","windows_build_info.json"),"utf-8"));t.isAPPX&&(console.info("App is probably running as appx"),Tt=t.isAPPX)}catch{console.warn("Could not fetch windows build info, this is normal in dev mode")}}}function st(e){let t="AppData\\Local\\DeltaChat",n="AppData\\Local\\Packages\\merlinux.DeltaChat_v2ry5hvxhdhyy\\LocalCache\\Local\\DeltaChat";if(Tt&&e.indexOf(t)>-1){let r=e.replace(t,n);if(ss(r))return r}return e}function gd(e){return hr(e,"../Packages/merlinux.DeltaChat_v2ry5hvxhdhyy/LocalCache/Local/DeltaChat")}f();import{existsSync as Dt}from"fs";import{join as lt,dirname as ls}from"path";import{fileURLToPath as cs}from"url";var wr=ls(cs(import.meta.url)),kt=process.env.DELTACHAT_LOCALE_DIR,bn=null;function We(){if(bn)return bn;let e=[kt,lt(wr,"../_locales"),lt(wr,"../../../_locales")];if(kt&&!br(kt))throw new Error(`Custom locale directory specified in \`DELTACHAT_LOCALE_DIR\` env var is not a valid locale directory.
      Make sure it exists and contains atleast the following files:
      - _languages.json        // index of what languages exist
      - _untranslated_en.json  // for untranslated strings
      - en.json                // for fallback
      
      Path to the invalid directory: ${kt}`);let t=e.find(br);if(!t)throw new Error("Failed to find locale data");return bn=t,t}function br(e){return e!==void 0&&Dt(e)&&Dt(lt(e,"_languages.json"))&&Dt(lt(e,"_untranslated_en.json"))&&Dt(lt(e,"en.json"))}import{Menu as yr,shell as ct}from"electron";import{readFileSync as us}from"fs";import{join as ds}from"path";var _r=x("main/menu"),fs=(()=>{let e=ds(We(),"_languages.json"),t=JSON.parse(us(e,"utf8"));return Object.keys(t).map(n=>({locale:n,name:t[n]})).filter(({name:n})=>n.indexOf("*")===-1).sort(({name:n},{name:r})=>n>r?1:-1)})(),yn=null;function Y(){if(_r.info(`rebuilding menu with locale ${Fe().locale}`),!yn){_r.critical("logHandlerRef not defined, could not build menu");return}let e=hs(yn),t=yr.buildFromTemplate(e),n=gs(t,p("global_menu_view_floatontop_desktop"));if(n&&(n.checked=gn()),process.platform==="darwin"===!0){yr.setApplicationMenu(t);return}d?.setMenu(t)}function vr(e){yn=e,Y()}function ps(){let{locale:e}=Fe();return fs.map(({locale:t,name:n})=>({label:n,type:"radio",checked:t===e,click:()=>{v.update({locale:t}),at(t)}}))}function ms(){let e=[{scale:.6,key:"extra_small"},{scale:.8,key:"small"},{scale:1,key:"normal"},{scale:1.2,key:"large"},{scale:1.4,key:"extra_large"}],t=v.state.zoomFactor;return e.map(({scale:n})=>n).indexOf(t)===-1&&e.push({scale:t,key:"custom"}),e.map(({key:n,scale:r})=>({label:r===1&&n==="custom"?p("custom"):`${r}x ${p(n)}`,type:"radio",checked:r===v.state.zoomFactor&&!(r===1&&n==="custom"),click:()=>{n!=="custom"&&(v.update({zoomFactor:r}),wn(r))}}))}function ve(e){let t=e===d,n=[{label:p("global_menu_help_about_desktop"),click:()=>{$("showAboutDialog")}},{type:"separator"},{label:p("menu_settings"),click:()=>{$("showSettingsDialog")},accelerator:"Cmd+,"},{type:"separator"}];return{label:ce,submenu:[...t?n:[],{role:"hide"},{role:"hideOthers"},{role:"unhide"},{type:"separator"},...t?[{label:p("show_window"),click:()=>{rt()}}]:[],{label:p("global_menu_file_quit_desktop"),role:"quit",accelerator:"Cmd+q"}]}}function xe(e,t){let n={label:p("global_menu_file_desktop"),submenu:e===d?[{label:p("menu_settings"),click:()=>{$("showSettingsDialog")},accelerator:"Ctrl+,"},{label:p("global_menu_file_quit_desktop"),click:Et,accelerator:"Ctrl+q"}]:[{label:p("close_window"),click:()=>e?.close(),accelerator:"Ctrl+q"}]},r={label:p("global_menu_file_desktop"),submenu:[{label:p("close_window"),click:()=>{e?.close(),t&&Y()},accelerator:"Cmd+w"}]};return t?r:n}function _n(){return{label:p("global_menu_edit_desktop"),submenu:[{label:p("global_menu_edit_undo_desktop"),role:"undo"},{label:p("global_menu_edit_redo_desktop"),role:"redo"},{type:"separator"},{label:p("global_menu_edit_cut_desktop"),role:"cut"},{label:p("global_menu_edit_copy_desktop"),role:"copy"},{label:p("global_menu_edit_paste_desktop"),role:"paste"},{label:p("delete"),role:"delete"},{label:p("menu_select_all"),role:"selectAll"}]}}function ut(e){return{label:p("global_menu_help_desktop"),role:"help",submenu:[{label:p("menu_help"),click:()=>{$("showHelpDialog")},accelerator:"F1"},{label:p("keybindings"),click:()=>{d?.show(),d?.focus(),$("showKeybindingsDialog")},accelerator:e?"Cmd+/":"Ctrl+/"},{type:"separator"},{label:p("delta_chat_homepage"),click:()=>{ct.openExternal(Ao)}},{label:p("contribute"),click:()=>{ct.openExternal("https://delta.chat/contribute")}},{label:p("global_menu_help_report_desktop"),click:()=>{ct.openExternal(No)}},{type:"separator"},{label:p("global_menu_help_about_desktop"),click:()=>{d?.show(),d?.focus(),$("showAboutDialog")}}]}}function hs(e){let t=process.platform==="darwin";return[...t?[ve(d)]:[],xe(d,t),_n(),{label:p("global_menu_view_desktop"),submenu:[{label:p("global_menu_view_floatontop_desktop"),type:"checkbox",click:()=>hn()},{label:p("zoom"),submenu:ms()},{label:p("pref_language"),submenu:ps()},{type:"separator"},{label:p("global_menu_view_developer_desktop"),submenu:[{label:p("global_menu_view_developer_tools_desktop"),accelerator:process.platform==="darwin"?"Alt+Command+I":"Ctrl+Shift+I",click:()=>it()},{label:p("menu.view.developer.open.log.folder"),click:()=>{ct.openPath(st(K()))}},{label:p("menu.view.developer.open.current.log.file"),click:()=>{ct.openPath(st(e.logFilePath()))}}]}]},ut(t)]}function gs(e,t){for(let n=0;n<e.items.length;n++){let r=e.items[n].submenu?.items.find(function(o){return o.label===t});if(r)return r}}import ws from"path";import xr from"fs";import{ipcMain as Er}from"electron";var $e=x("load-translations"),vn=null;function Fe(){if(vn===null)throw $e.error("tried to get locale data before init"),new Error("no locale data is loaded yet");return vn}var xn=null,p=function(e,t,n){return xn===null?($e.error("tried to use translation function before init"),e):xn(e,t,n)};function Pt(e){let t=Cr(e);vn=t,xn=Io(t.locale,t.messages)}function Cr(e){let t=Ot(St("en")),n,r=St(e),o=Ot(r);!o&&e.indexOf("-")!==-1?(e=e.split("-")[0],r=St(e),o=Ot(r)):o||($e.error(`Could not load messages for ${e}`,e),e="en",n=t),o&&(n=Object.assign({},t,o));let i=St("_untranslated_en"),a=Ot(i);return a?n=Object.assign(n,a):$e.debug(`No experimental language file (${i}) found`),$e.debug(n.no_chat_selected_suggestion_desktop),{messages:n,locale:e}}function St(e){let t=e.replace("-","_");return ws.join(We(),t+".json")}function Ot(e){if(!xr.existsSync(e))return!1;try{return JSON.parse(xr.readFileSync(e,"utf-8"))}catch(t){throw $e.error(`JSON parse error in language file '${e}'`,t),t}}Er.handle("getLocaleData",(e,t)=>(t&&Cr(t),Fe())),Er.handle("setLocale",(e,t)=>{Pt(t),Y()});import Be from"electron";var pe=e=>e.webContents,bs=e=>{let t;return e.filter(n=>{if(n){if(typeof n=="object"&&n.visible===!1)return!1}else return!1;return!0}).filter((n,r,o)=>{let i=n,a=o,s=i.type==="separator"&&(!t||r===o.length-1||a[r+1].type==="separator");return t=s?t:i,!s})},ys=e=>{let n=(r,o)=>{let{editFlags:i}=o,a=o.selectionText.trim().length>0,s=m=>i[`can${m}`]&&a,c={separator:()=>({type:"separator"}),learnSpelling:()=>({id:"learnSpelling",label:p("menu_learn_spelling"),visible:!!(o.isEditable&&a&&o.misspelledWord),click(){pe(e).session.addWordToSpellCheckerDictionary(o.misspelledWord)}}),cut:()=>({id:"cut",label:p("global_menu_edit_cut_desktop"),enabled:s("Cut"),visible:o.isEditable,click(m){let g=pe(e);g?g.cut():Be.clipboard.writeText(o.selectionText)}}),copy:()=>({id:"copy",label:p("global_menu_edit_copy_desktop"),enabled:s("Copy"),visible:o.isEditable||a,click(){let m=pe(e);m?m.copy():Be.clipboard.writeText(o.selectionText)}}),paste:()=>({id:"paste",label:p("global_menu_edit_paste_desktop"),enabled:i.canPaste,visible:o.isEditable,click(){pe(e).paste()}}),copyLink:()=>({id:"copyLink",label:p("menu_copy_link_to_clipboard"),visible:o.linkURL.length!==0&&o.mediaType==="none",click(){Be.clipboard.write({bookmark:o.linkText,text:o.linkURL})}}),copyImage:()=>({id:"copyImage",label:p("menu_copy_image_to_clipboard"),visible:o.mediaType==="image",click(){pe(e).copyImageAt(o.x,o.y)}})};function l(m){return{id:"dictionarySuggestions",label:m,visible:!!(o.isEditable&&a&&o.misspelledWord),click(g){g.label&&pe(e).insertText(g.label)}}}let u=[],h=[u.length>0&&c.separator(),...u,c.separator(),!1,c.separator(),c.cut(),c.copy(),c.paste(),c.separator(),c.copyImage(),c.separator(),c.copyLink(),c.separator()];h=bs(h),h.length>0&&Be.Menu.buildFromTemplate(h).popup({window:e})};return pe(e).on("context-menu",n),()=>{e.isDestroyed()||pe(e).removeListener("context-menu",n)}},_s=()=>{let e=!1,t=[],n=a=>{if(e)return;let s=ys(a);t.push(s);let c=()=>{let l=t.indexOf(s);l!==-1&&t.splice(l,1)};typeof a.once<"u"&&a.once("closed",c),t.push(()=>{a.off("closed",c)})},r=()=>{for(let a of t)a();t.length=0,e=!0};for(let a of Be.BrowserWindow.getAllWindows())n(a);let o=Be.app,i=(a,s)=>{n(s)};return o.on("browser-window-created",i),t.push(()=>{o.removeListener("browser-window-created",i)}),r},Tr=_s;f();function Dr(){console.info(`Options:

Flag
--                              indicates the end of DeltaChat options
-h, --help                      Print DeltaChat command line options (currently set).
--minimized                     Start deltachat in minimized mode with trayicon (trayicon will be activated
                                for this session regardless whether it's disabled)
-v, --version                   Prints DeltaChat version.

Development Options
--translation-watch             enable auto-reload for _locales/_untranslated_en.json
--dev-mode                      opens electron devtools and activates --log-debug & --log-to-console

Theme
--theme <theme-id>              set a specific theme (see THEMES.md)
--theme-watch                   enable auto-reload for the active theme

Logging
--log-debug                     Log debug messages
--log-to-console                Output the log to stdout / Chrome dev console
--machine-readable-stack        Enable JSON stack trace
--no-color                      Disable colors in the output of main process

For more info on logging see LOGGING.md.)`)}f();import{powerMonitor as En}from"electron";function Cn(){d?.webContents.send("onResumeFromSleep")}function kr(){En.on("resume",Cn),En.on("unlock-screen",Cn),En.on("user-did-become-active",Cn)}f();import{createWriteStream as vs}from"fs";import{join as Tn}from"path";import{stdout as xs,stderr as Es}from"process";xs.on("error",()=>{}),Es.on("error",()=>{});function Cs(){let e=K(),t=new Date;function n(o){return o<10?"0"+o:o}let r=[`${t.getFullYear()}-`,`${n(t.getMonth()+1)}-`,`${n(t.getDate())}-`,`${n(t.getHours())}-`,`${n(t.getMinutes())}-`,`${n(t.getSeconds())}`,".log"].join("");return Tn(e,r)}function Sr(){let e=Cs(),t=vs(e,{flags:"w"});return console.log(`Logfile: ${e}`),{log:(n,r,o,...i)=>{let s=[new Date().toISOString(),Ss(n,22),r];s=s.concat([o,...i].map(c=>JSON.stringify(c))),t.writable?t.write(`${s.join("	")}
`):console.warn("tried to log something after logger shut down",{channel:n,level:r,args:i,stacktrace:o})},end:()=>t.end(),logFilePath:()=>e}}import{readdir as Ts,lstat as Ds,unlink as ks}from"fs/promises";async function Or(){let e=x("logger/log-cleanup"),t=K(),n=await Ts(t),o=(await Promise.all(n.map(async i=>({filename:i,mtime:(await Ds(Tn(t,i))).mtime.getTime()})))).sort((i,a)=>i.mtime-a.mtime);if(o.length>10){o.splice(o.length-11);let i=await Promise.all(o.map(({filename:a})=>ks(Tn(t,a))));e.info(`Successfuly deleted ${i.length} old logfiles`)}else e.debug("Nothing to do (not more than 10 logfiles to delete)")}function Ss(e,t){return e.length<t?e+" ".repeat(t-e.length):e}f();f();import{BrowserWindow as Os,Menu as It,shell as Ps}from"electron";import{join as Dn}from"path";import{stat as Is}from"fs/promises";import{platform as Ls}from"os";var dt=x("main/help");async function As(e){let t=Dn(A(),`help/${e}/help.html`);try{if(!(await Is(Dn(t))).isFile())throw dt.warn("contentFilePath not a file"),new Error("contentFilePath not a file");return t}catch{return dt.warn(`Did not find help file for language ${e}, falling back to english`),Dn(A(),"help/en/help.html")}}var P=null;async function Pr(e,t){if(P){P.focus(),t&&P.webContents.executeJavaScript(`
        document.getElementById(atob("${btoa(t)}"))?.scrollIntoView({"behavior":"smooth"})
      `);return}dt.debug("open help",e);let n={bounds:{width:500,height:638},headerHeight:36,minWidth:450,minHeight:450},r=P=new Os({backgroundColor:"#282828",darkTheme:!0,icon:ue(),show:!1,title:ce+" - "+p("menu_help"),useContentSize:!0,webPreferences:{contextIsolation:!0,sandbox:!0,spellcheck:!1},alwaysOnTop:d?.isAlwaysOnTop()});fe(r);let o=Re(r,n.minWidth,n.minHeight),i=await As(e);dt.debug(i),P.loadFile(i),P.once("ready-to-show",async()=>{t&&await r.webContents.executeJavaScript(`
      document.getElementById(atob("${btoa(t)}"))?.scrollIntoView({"behavior":"instant"})
      `),r.show()}),P.setSheetOffset&&P.setSheetOffset(n.headerHeight),P.webContents.on("will-navigate",(c,l)=>{dt.debug("open ",l),Ps.openExternal(l)}),P.on("close",c=>{P=null,o()}),P.setMenu(It.buildFromTemplate([{role:"viewMenu"}])),P.webContents.executeJavaScript(`
    const body = document.getElementsByTagName('body')[0];
    const back_btn = document.createElement('button');
    back_btn.className = 'back-btn';
    back_btn.onclick = (ev) => {document.body.scrollTop = 0; document.documentElement.scrollTop = 0;};
    back_btn.innerText = '\u2191 ${p("menu_scroll_to_top")}';
    body.append(back_btn);
  `),P.webContents.session.setPermissionCheckHandler((c,l)=>!1),P.webContents.session.setPermissionRequestHandler((c,l,u)=>u(!1));let a=Ls()==="darwin",s=()=>It.buildFromTemplate([...a?[ve(r)]:[],xe(P,a),{label:p("global_menu_edit_desktop"),submenu:[{label:p("global_menu_edit_copy_desktop"),role:"copy"},{label:p("menu_select_all"),role:"selectAll"}]},{label:p("global_menu_view_desktop"),submenu:[{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"},{type:"separator"},{label:p("global_menu_view_floatontop_desktop"),type:"checkbox",checked:P?.isAlwaysOnTop(),click:()=>{P?.setAlwaysOnTop(!P.isAlwaysOnTop()),a?P?.setMenu(s()):It.setApplicationMenu(s())}},{role:"togglefullscreen"}]},ut(a)]);a||P.setMenu(s()),P.on("focus",()=>{a&&It.setApplicationMenu(s())}),P.on("blur",()=>{a&&Y()})}f();f();function je(e,t){return e.length>t?e.slice(0,t)+"\u2026":e}function Ir(e){return e.startsWith("https://i.delta.chat/")&&e.includes("#")}function Mf(e,t){let n,r,o,i=(...a)=>{n?(clearTimeout(r),r=setTimeout(()=>{e(...a),o=performance.now()},Math.max(t-(performance.now()-o),0))):(e(...a),o=performance.now(),n=!0)};return i.cancel=()=>{clearTimeout(r)},i}f();import{app as Ns,ipcMain as kn}from"electron";import{readFile as Ms}from"fs/promises";import{basename as Rs}from"path";import{platform as Ws}from"os";var Z=x("main/open_url"),z=Ns;Ws()!=="linux"&&(z.setAsDefaultProtocolClient("openpgp4fpr"),z.setAsDefaultProtocolClient("OPENPGP4FPR"),z.setAsDefaultProtocolClient("dcaccount"),z.setAsDefaultProtocolClient("DCACCOUNT"),z.setAsDefaultProtocolClient("dclogin"),z.setAsDefaultProtocolClient("DCLOGIN"));var Sn=!1;kn.once("frontendReady",()=>{Sn=!0});function Lr(e){e.toUpperCase().startsWith("OPENPGP4FPR")&&e.indexOf("#")===-1?$("open-url",e.replace("%23","#")):$("open-url",e)}var Ue=function(e){Z.info("open_url was called");let t=()=>{Z.info("open-url: Sending url to frontend."),Sn?Lr(e):kn.once("frontendReady",()=>{Lr(e)})};if(Z.debug("open-url: sending to frontend:",e),z.ipcReady)return t();Z.debug("open-url: Waiting for ipc to be ready before opening url."),z.once("ipcReady",()=>{Z.debug("open-url: IPC ready."),t()})};z.on("open-url",(e,t)=>{Z.info("open url event"),e&&(e.preventDefault(),z.focus(),d?.focus()),Ue(t)});async function Ar(e){if(Z.info("open file",e),!e.endsWith(".xdc")){Z.info("handleWebxdcFileOpen, path does not contain .xdc",e);return}z.focus(),d?.focus();let t=await Ms(e);z.ipcReady||await new Promise(n=>z.once("ipcReady",n)),Sn||await new Promise(n=>kn.once("frontendReady",n)),d?.webContents.send("webxdc.sendToChat",{file_name:Rs(e),file_content:t.toString("base64")},null)}z.on("open-file",async(e,t)=>{e&&e.preventDefault(),Ar(t)});function On(e){e:for(let t=1;t<e.length;t++){let n=e[t];if(n.endsWith(".xdc")){Z.debug("open-url: process something that looks like it could be a webxc file:",n),Ar(n);continue}if(n.includes(":")){Z.debug("open-url: process something that looks like it could be a scheme:",n);for(let r of Qo)if(n.startsWith(r.toUpperCase())||n.startsWith(r.toLowerCase())){Z.debug("open-url: Detected URI: ",n),Ue(n);continue e}}}}z.on("second-instance",(e,t)=>{Z.debug("Someone tried to run a second instance"),On(t),d&&ye()});f();f();function Pn(e){let t=/.theme-meta ?{([^]*)}/gm.exec(e)?.[1].trim()||"",n=/--(\w*): ?['"]([^]*?)['"];?/gi,r={},o=!0;for(;o;)o=n.exec(t),o&&(r[o[1]]=o[2]);if(!r.name||!r.description)throw new Error("The meta variables meta.name and meta.description must be defined");return r}var Lt="dev_";import{existsSync as Fs,watchFile as $s}from"fs";import{readFile as Nr,readdir as Bs}from"fs/promises";import{join as In,basename as Ln}from"path";import{app as js,ipcMain as Mr,nativeTheme as Rr}from"electron";var re=js,ee=x("main/themes"),Wr=In(A(),"themes");async function Fr(e,t){let n=await Bs(e);return Promise.all(n.filter(r=>r.endsWith(".css")&&r.charAt(0)!=="_").map(async r=>{let o=t+":"+Ln(r,".css"),i=await Nr(In(e,r),"utf-8");try{let a=Pn(i);return{name:a.name,description:a.description,address:o,is_prototype:r.startsWith(Lt)}}catch(a){return ee.error("Error while parsing theme ${address}: ",a),{name:o+" [Invalid Meta]",description:"[missing description]",address:t+":"+Ln(r,".css"),is_prototype:r.startsWith(Lt)}}}))}async function Us(){return[...await Fr(Wr,"dc"),...await Fr(nt(),"custom")]}async function Nn(e){let t=An(e);ee.debug("load theme file",e,t);let n=await Nr(t,"utf-8");ee.debug("render theme data");let r=Pn(n);return ee.debug("render theme data for theme:",r),{theme:{name:r.name,description:r.description,address:e,is_prototype:Ln(t).startsWith(Lt)},data:n}}function Hs(){return Rr.shouldUseDarkColors?["dc","dark"]:["dc","light"]}function An(e){let t=e!="system"?e.split(":"):Hs(),n="";if(t.length!=2)throw"not an theme address, must have the format [location]:[themename]";if(t[0]=="dc")n=`${Wr}`;else if(t[0]=="custom")n=nt();else throw'unknown "location", valid locations are dc or custom';let r=In(n,t[1].replace(/\/|\\|\.\./g,"")+".css");if(Fs(r))return r;throw"theme "+e+" not found at: "+r}function $r(){if(re.rc.theme){ee.info(`trying to load theme from '${re.rc.theme}'`);try{An(re.rc.theme)}catch(e){throw ee.error("THEME NOT FOUND",{error:e,path:re.rc.theme}),new Error(`THEME "${re.rc.theme}" NOT FOUND,
this is fatal because the user specified it via cli argument.
If you did not specify this, ask the person which installed deltachat for you to remove the cli argument again.

If they are not available find the shortcut/.desktop file yourself and edit it to not contain the "--theme" argument.
Using --theme is for developers and theme creators ONLY and should not be used by normal users
If you have question or need help, feel free to ask in our forum https://support.delta.chat.`)}v.update({activeTheme:re.rc.theme}),ee.info("set theme"),re.rc["theme-watch"]&&(ee.info("theme-watch: activated",re.rc["theme-watch"]),$s(An(re.rc.theme),(e,t)=>{e.mtime!==t.mtime&&(ee.info("theme-watch: File changed reminding frontend to reload theme"),re.ipcReady&&$("theme-update"))}))}Rr.on("updated",()=>{$("theme-update")})}Mr.handle("themes.getActiveTheme",async()=>{try{return ee.debug("theme",v.state.activeTheme),await Nn(v.state.activeTheme)}catch(e){return ee.error("loading theme failed:",e),null}}),Mr.handle("themes.getAvailableThemes",Us);import He,{dialog as Br,Menu as Mn,MenuItem as ft,nativeTheme as Vs,session as zs,shell as qs,WebContentsView as Gs}from"electron";import{clipboard as Js}from"electron/common";import{join as jr}from"path";import{platform as Ur}from"os";var Rn=x("html_email"),At={};function qr(e,t,n,r,o,i,a){let s=`${e}.${t}`;if(At[s]){At[s].focus();return}let c=v.state.HTMLEmailWindowBounds||{height:621,width:800,x:void 0,y:void 0},l=At[s]=new He.BrowserWindow({backgroundColor:"#282828",darkTheme:!0,icon:ue(),show:!1,title:`${je(r,42)} \u2013 ${je(o,40)}`,height:c.height,width:c.width,x:c.x,y:c.y,webPreferences:{nodeIntegration:!1,preload:jr(A(),"electron_html_email_view/electron_html_email_view_preload.js"),spellcheck:!1,webSecurity:!0,allowRunningInsecureContent:!1,contextIsolation:!0},alwaysOnTop:Q?.isAlwaysOnTop()});l.webContents.setZoomFactor(v.state.zoomFactor),fe(l);let u=Re(l,400,300),h=v.state.HTMLEmailAlwaysLoadRemoteContent&&!n;l.webContents.ipc.handle("html_email:get_info",S=>({subject:r,from:o,receiveTime:i,networkButtonLabelText:p("load_remote_content"),toggle_network:h})),Vs.on("updated",()=>{try{l.webContents.ipc.emit("theme-update")}catch{}}),l.webContents.ipc.handle("get-theme",async()=>(await Nn(v.state.activeTheme)).data),l.webContents.on("will-navigate",(S,O)=>{S.preventDefault()}),l.once("ready-to-show",()=>{l.show()}),l.on("close",()=>{D?.(),delete At[s],u()});let m=Ur()==="darwin",g=()=>Mn.buildFromTemplate([...m?[ve(l)]:[],xe(l,m),{label:p("global_menu_edit_desktop"),submenu:[{label:p("global_menu_edit_copy_desktop"),role:"copy"},{label:p("menu_select_all"),click:()=>{w.webContents.focus(),w.webContents.selectAll()},accelerator:m?"Cmd+A":"Ctrl+A"}]},{label:p("global_menu_view_desktop"),submenu:[{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"},{type:"separator"},{label:p("global_menu_view_floatontop_desktop"),type:"checkbox",checked:l.isAlwaysOnTop(),click:()=>{l.setAlwaysOnTop(!l.isAlwaysOnTop()),Ur()!=="darwin"?l.setMenu(g()):Mn.setApplicationMenu(g())}},{role:"togglefullscreen"}]},ut(m)]);m||l.setMenu(g()),l.on("focus",()=>{m&&Mn.setApplicationMenu(g())}),l.on("blur",()=>{m&&Y()});let w=Vr(e,h,a,l);l.contentView.addChildView(w),w.webContents.setZoomFactor(v.state.zoomFactor*Math.pow(1.2,l.webContents.getZoomLevel()));let D=zr(l,w.webContents);l.webContents.ipc.handle("html-view:more-menu",(S,{x:O,y:T})=>{let b={separator:()=>({type:"separator"}),always_show:()=>({id:"always_show",type:"checkbox",label:p("always_load_remote_images"),checked:v.state.HTMLEmailAlwaysLoadRemoteContent,click(){let L=!v.state.HTMLEmailAlwaysLoadRemoteContent;v.update({HTMLEmailAlwaysLoadRemoteContent:L}),y(null,L,!0),l.webContents.executeJavaScript(`document.getElementById('toggle_network').checked = window.network_enabled= ${!!L}`)}}),dont_ask:()=>({id:"show_warning",type:"checkbox",label:p("show_warning"),checked:v.state.HTMLEmailAskForRemoteLoadingConfirmation,click(){v.update({HTMLEmailAskForRemoteLoadingConfirmation:!v.state.HTMLEmailAskForRemoteLoadingConfirmation})}})},C;n?C=He.Menu.buildFromTemplate([b.dont_ask()]):C=He.Menu.buildFromTemplate([b.always_show(),b.dont_ask()]),C.popup({window:l,x:O,y:T})}),l.webContents.ipc.handle("html-view:resize-content",(S,O)=>{let T=v.state.zoomFactor*Math.pow(1.2,l.webContents.getZoomLevel()),b=l.webContents.getZoomFactor(),C=l.getBounds(),L=l.getContentSize(),E=O.width*b,X=O.height*b,_=L[1]-X;w?.setBounds({x:O.x,y:_,width:E,height:X}),w?.webContents.setZoomFactor(T),v.update({HTMLEmailWindowBounds:C})}),l.on("moved",()=>{let S=l.getBounds();v.update({HTMLEmailWindowBounds:S})});let y=async(S,O,T=!1)=>{if(!T&&!n&&!O&&v.state.HTMLEmailAlwaysLoadRemoteContent&&v.update({HTMLEmailAlwaysLoadRemoteContent:!1}),!T&&O&&v.state.HTMLEmailAskForRemoteLoadingConfirmation){let C=[{label:p("no"),action:()=>{throw new Error("user denied")}},{label:p("yes"),action:()=>{}}].filter(E=>typeof E=="object"),L=await Br.showMessageBox(l,{message:p("load_remote_content_ask"),buttons:C.map(E=>E.label),type:"none",icon:"",defaultId:0,cancelId:0});C[L.response].action()}let b=w?.getBounds();l.contentView.removeChildView(w),D(),w.webContents.close(),w=Vr(e,O,a,l),l.contentView.addChildView(w),D=zr(l,w.webContents),b&&w.setBounds(b)};l.webContents.ipc.handle("html-view:change-network",y),l.loadFile(jr(A(),"electron_html_email_view/electron_html_email_view.html"))}var Ks=`default-src 'none';
font-src 'self' data:;
frame-src 'none';
img-src 'self' data:;
media-src 'self' data:;
style-src 'self' data: 'unsafe-inline';
form-action 'none';
script-src 'none';`.replace(/\n/g,""),Hr=`
default-src 'none';
font-src 'self' data: http: https:;
frame-src 'none';
img-src 'self' blob: data: https: http:;
media-src 'self' data: http: https:;
style-src 'self' 'unsafe-inline';
form-action 'none';
script-src 'none';
`.replace(/\n/g,"");function Vr(e,t,n,r){let o=zs.fromPartition(`${Date.now()}`,{cache:!1});if(o.setProxy({mode:"fixed_servers",proxyRules:"not-existing-proxy:80"}),t||(o.protocol.handle("http",()=>new Response("",{status:404})),o.protocol.handle("https",()=>new Response("",{status:404}))),o.protocol.handle("email",()=>new Response(Buffer.from(n),{status:200,headers:{"content-type":"text/html; charset=utf-8","Content-Security-Policy":t?Hr:Ks}})),t){let s=async c=>{try{let l=await Gr().getHttpResponse(e,c.url),u=Buffer.from(l.blob,"base64");return new Response(u,{status:200,headers:{"Content-Security-Policy":Hr,"Content-Type":`${l.mimetype}; ${l.encoding}`}})}catch(l){return Rn.info("remote content failed to load",c.url,l),new Response(Buffer.from(l?.message),{status:400,headers:{mimeType:"text/plain"}})}};o.protocol.handle("http",s),o.protocol.handle("https",s)}let i=new Gs({webPreferences:{accessibleTitle:"email content",contextIsolation:!0,javascript:!1,disableDialogs:!0,webgl:!1,sandbox:!0,spellcheck:!1,session:o}});i.webContents.loadURL("email://index.html"),i.webContents.insertCSS(`:root {
      color: black;
      background-color: white;
    }`);let a=s=>{s.startsWith("mailto:")||Ir(s)?(Ue(s),d?.show()):s.startsWith("http:")||s.startsWith("https:")?qs.openExternal(s):Br.showMessageBox(r,{buttons:[p("no"),p("menu_copy_link_to_clipboard")],message:p("ask_copy_unopenable_link_to_clipboard",s)}).then(({response:c})=>{c==1&&Js.writeText(s)})};return i.webContents.on("will-navigate",(s,c)=>{s.preventDefault();let l="email://index.html";if(c.startsWith(l)){let u=c.slice(l.length);if(c.slice(l.length)[0]=="/"&&(u=u.slice(1)),u.startsWith("#")){let h=u.split("#").reverse()[0];i.webContents.loadURL(`email://index.html/${Math.random()}/#${h}`).catch(Rn.error.bind(Rn,"error"));return}else return a("https://"+u)}a(c)}),i.webContents.setWindowOpenHandler(s=>(a(s.url),{action:"deny"})),i}var zr=(e,t)=>{let n=(r,o)=>{let{editFlags:i}=o,a=o.selectionText.trim().length>0,s=[];(o.isEditable||a)&&s.push(new ft({id:"copy",label:p("global_menu_edit_copy_desktop"),enabled:i.canCopy&&a,click(){t?t.copy():He.clipboard.writeText(o.selectionText)}})),o.mediaType==="image"&&(s.length&&s.push(new ft({type:"separator"})),s.push(new ft({id:"copyImage",label:p("menu_copy_image_to_clipboard"),click(){t.copyImageAt(o.x,o.y)}}))),o.linkURL.length!==0&&o.mediaType==="none"&&(s.length&&s.push(new ft({type:"separator"})),s.push(new ft({id:"copyLink",label:p("menu_copy_link_to_clipboard"),click(){He.clipboard.write({bookmark:o.linkText,text:o.linkURL})}}))),s.length&&He.Menu.buildFromTemplate(s).popup({window:e})};return t.on("context-menu",n),()=>{e.isDestroyed()||t.removeListener("context-menu",n)}};f();f();import{app as Ys,BrowserWindow as Zs,protocol as Xs,ipcMain as F,session as Jr,screen as Qs}from"electron/main";import Kr from"mime-types";import{Menu as Wn,nativeImage as Yr,shell as Zr,dialog as Xr,clipboard as el}from"electron";import{join as le,dirname as tl}from"path";import{fileURLToPath as nl}from"url";import{platform as Qr}from"os";import{readdir as ei,stat as ti,rmdir as ol,writeFile as rl,readFile as il}from"fs/promises";import{existsSync as al}from"fs";var nm=tl(nl(import.meta.url)),B=x("main/deltachat/webxdc"),I={},ni=[],oi="default-src 'self';  style-src 'self' 'unsafe-inline' blob: ;  font-src 'self' data: blob: ;  script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: ;  connect-src 'self' data: blob: ;  img-src 'self' data: blob: ;  media-src 'self' data: blob: ;  webrtc 'block'",sl=["pointerLock","fullscreen"],ri="webxdc-wrapper.45870014933640136498.html",Fn="ui.desktop.webxdcBounds",ll={width:375,height:667},cl={width:1e3,height:800},pt=class{constructor(t){this.controller=t;Ys.whenReady().then(()=>{Xs.handle("webxdc-icon",async r=>{let[o,i]=r.url.substring(12).split("."),[a,s]=[Number(o),Number(i)];try{let{icon:c}=await this.rpc.getWebxdcInfo(a,s),l=Buffer.from(await this.rpc.getWebxdcBlob(a,s,c),"base64");return new Response(l,{headers:{"content-type":Kr.lookup(c)||""}})}catch(c){return B.error("failed to load webxdc icon for:",c),new Response("",{status:404})}})});let n=async(r,o,i,a=ll)=>{let{webxdcInfo:s,chatName:c,accountId:l,href:u}=i,h="",m=`webxdc://${l}.${o}.webxdc`;if(u&&u!==""){let _=new URL(u,"http://dummy"),H=_.pathname+_.search+_.hash;h=Buffer.from(m+H).toString("base64")}if(I[`${l}.${o}`]){B.warn("webxdc instance for this app is already open, trying to focus it",{msg_id:o});let _=I[`${l}.${o}`].win;_.isMinimized()&&_.restore(),h!==""&&_.webContents.executeJavaScript(`window.webxdc_internal.setLocationUrl("${h}")`),_.focus();return}B.info("opening new webxdc instance",{msg_id:o});let g=s.icon,w=Buffer.from(await this.rpc.getWebxdcBlob(l,o,g),"base64");if(!ni.includes(l)){let _=Nt(l);ni.push(l),_.protocol.handle("webxdc",(...H)=>ul(this.rpc,...H))}let D=w&&Yr?.createFromBuffer(w),y=new Zs({webPreferences:{partition:ai(l),sandbox:!0,contextIsolation:!0,webSecurity:!0,nodeIntegration:!1,navigateOnDragDrop:!1,devTools:v.state.enableWebxdcDevTools,javascript:!0,preload:le(A(),"webxdc-preload.js")},title:ii(s,c),icon:D||void 0,alwaysOnTop:d?.isAlwaysOnTop(),show:!1});fe(y);let S=await this.getLastBounds(l,o),O=dl(S||a),T={...S||{},...O};y.setBounds(T,!0),y.show(),I[`${l}.${o}`]={win:y,accountId:l,msgId:o,internet_access:s.internetAccess,selfAddr:s.selfAddr||"unknown@unknown",displayName:i.displayname||s.selfAddr||"unknown",sendUpdateInterval:s.sendUpdateInterval,sendUpdateMaxSize:s.sendUpdateMaxSize};let b=Qr()==="darwin",C=()=>Wn.buildFromTemplate([...b?[ve(y)]:[],xe(y,b),_n(),{label:p("global_menu_view_desktop"),submenu:[...v.state.enableWebxdcDevTools?[{label:p("global_menu_view_developer_tools_desktop"),role:"toggleDevTools"}]:[],{type:"separator"},{role:"resetZoom"},{role:"zoomIn"},{role:"zoomOut"},{type:"separator"},{label:p("global_menu_view_floatontop_desktop"),type:"checkbox",checked:y.isAlwaysOnTop(),click:()=>{y.setAlwaysOnTop(!y.isAlwaysOnTop()),Qr()!=="darwin"?y.setMenu(C()):Wn.setApplicationMenu(C())}},{role:"togglefullscreen"}]},{label:p("menu_help"),submenu:[{label:p("source_code"),enabled:!!s.sourceCodeUrl,icon:D?.resize({width:24})||void 0,click:()=>{if(s.sourceCodeUrl?.startsWith("https:")||s.sourceCodeUrl?.startsWith("http:"))Zr.openExternal(s.sourceCodeUrl);else if(s.sourceCodeUrl){let _=s.sourceCodeUrl;Xr.showMessageBox(y,{buttons:[p("no"),p("menu_copy_link_to_clipboard")],message:p("ask_copy_unopenable_link_to_clipboard",_)}).then(({response:H})=>{H==1&&el.writeText(_)})}}},{type:"separator"},{label:p("what_is_webxdc"),click:()=>Zr.openExternal("https://webxdc.org")}]}]);b||y.setMenu(C()),y.on("focus",()=>{b&&Wn.setApplicationMenu(C())}),y.on("blur",()=>{b&&Y()}),y.once("closed",()=>{delete I[`${l}.${o}`]}),y.once("close",()=>{let _=y.getBounds();this.setLastBounds(l,o,_)}),y.once("ready-to-show",()=>{h!==""&&y.webContents.executeJavaScript(`window.webxdc_internal.setLocationUrl("${h}")`)}),y.webContents.loadURL(m+"/"+ri,{extraHeaders:"Content-Security-Policy: "+oi}),y.webContents.on("will-navigate",_=>{_.preventDefault()});let L=!1;y.webContents.on("will-prevent-unload",_=>{L&&_.preventDefault(),setTimeout(()=>{if(y.isDestroyed())return;Xr.showMessageBoxSync(y,{type:"question",buttons:[p("close_window"),p("cancel")],title:p("webxdc_beforeunload_dialog_title"),message:p("webxdc_beforeunload_dialog_message"),defaultId:0,cancelId:1})===0&&(L=!0,y.close())},150)}),y.on("page-title-updated",_=>{_.preventDefault()});let E=new Set,X=_=>{let H=sl.includes(_);return E.has(_)||(E.add(_),H?B.info(`ALLOWED permission '${_}' to webxdc '${s.name}'`):B.info(`DENIED permission '${_}' to webxdc '${s.name}'. If you think that's a bug and you need that permission, then please open an issue on github.`)),H};y.webContents.session.setPermissionCheckHandler((_,H)=>X(H)),y.webContents.session.setPermissionRequestHandler((_,H,Qn)=>{Qn(X(H))}),y.webContents.on("before-input-event",(_,H)=>{H.code==="F12"&&v.state.enableWebxdcDevTools&&(y.webContents.toggleDevTools(),_.preventDefault())})};F.handle("open-webxdc",n),F.handle("webxdc.exitFullscreen",async r=>{let o=me(r);o&&o.win.isFullScreen()&&o.win.setFullScreen(!1)}),F.handle("webxdc.exit",async r=>{let o=me(r);o&&(o.win.loadURL("about:blank"),o.win.close())}),F.handle("webxdc.getAllUpdates",async(r,o=0)=>{let i=me(r);return i?await this.rpc.getWebxdcStatusUpdates(i.accountId,i.msgId,o):(B.error("webxdc.getAllUpdates failed, app not found in list of open ones"),[])}),F.handle("webxdc.sendUpdate",async(r,o)=>{let i=me(r);if(!i){B.error("webxdc.sendUpdate failed, app not found in list of open ones");return}try{return await this.rpc.sendWebxdcStatusUpdate(i.accountId,i.msgId,o,"")}catch(a){throw B.error("webxdc.sendUpdate failed:",a),a}}),F.handle("webxdc.sendRealtimeData",async(r,o)=>{let i=me(r);if(!i){B.error("webxdc.sendRealtimeData failed, app not found in list of open ones");return}try{return await this.rpc.sendWebxdcRealtimeData(i.accountId,i.msgId,o)}catch(a){throw B.error("webxdc.sendWebxdcRealtimeData failed:",a),a}}),F.handle("webxdc.sendRealtimeAdvertisement",async r=>{let o=me(r);if(!o){B.error("webxdc.sendRealtimeAdvertisement failed, app not found in list of open ones");return}await this.rpc.sendWebxdcRealtimeAdvertisement(o.accountId,o.msgId)}),F.handle("webxdc.leaveRealtimeChannel",async r=>{let o=me(r);if(!o){B.error("webxdc.leaveRealtimeChannel, app not found in list of open ones");return}this.rpc.leaveWebxdcRealtime(o.accountId,o.msgId)}),F.handle("webxdc.sendToChat",(r,o,i)=>{let a=me(r);if(!a){B.error("webxdc.sendToChat failed, app not found in list of open ones");return}d?.webContents.send("webxdc.sendToChat",o,i,a.accountId),d?.focus()}),F.handle("close-all-webxdc",()=>{this._closeAll()}),F.handle("webxdc:custom:drag-file-out",async(r,o,i,a)=>{let s=await $n(o,i),c=le(A(),"images/electron-file-drag-out.png");a&&(c=Yr.createFromDataURL(a)),r.sender.startDrag({file:s,icon:c})}),F.handle("webxdc:status-update",(r,o,i)=>{let a=I[`${o}.${i}`];a&&a.win.webContents.send("webxdc.statusUpdate")}),F.handle("webxdc:realtime-data",async(r,o,i,a)=>{let s=I[`${o}.${i}`];s?s.win.webContents.send("webxdc.realtimeData",a):this.rpc.leaveWebxdcRealtime(o,i)}),F.handle("webxdc:message-changed",async(r,o,i)=>{let a=I[`${o}.${i}`];if(a){let{chatId:s,webxdcInfo:c}=await this.rpc.getMessage(o,i),{name:l}=await this.rpc.getBasicChatInfo(o,s);a.win&&c&&(a.win.title=ii(c,l))}}),F.handle("webxdc:instance-deleted",(r,o,i)=>{let a=`${o}.${i}`,s=I[a];s&&s.win.close(),this.removeLastBounds(o,i);let c=Nt(o),l=`webxdc://${a}.webxdc`;c.clearStorageData({origin:l}),c.clearData({origins:[l]}),c.clearCodeCaches({urls:[l]}),c.clearCache()}),F.handle("open-maps-webxdc",async(r,o,i)=>{let a=await this.rpc.initWebxdcIntegration(o,i??null);if(!a){let s=A().replace("app.asar","app.asar.unpacked");await this.rpc.setWebxdcIntegration(o,le(s,"/xdcs/maps.xdc")),a=await this.rpc.initWebxdcIntegration(o,i??null)}if(a){let s=p("menu_show_global_map");if(i){let u=await this.rpc.getBasicChatInfo(o,i);s=p("locations")+" - "+u.name}else{let u=await this.rpc.getAccountInfo(o);"displayName"in u&&u.displayName!==null&&(s=p("menu_show_global_map")+" - "+u.displayName)}let c=`${o}.${a}`;I[c]!==void 0&&(I[c].win.loadURL("about:blank"),I[c].win.close());let l=await this.rpc.getMessage(o,a);l&&l.webxdcInfo&&n(r,a,{accountId:o,displayname:"",chatName:s,webxdcInfo:l.webxdcInfo,href:""},cl)}})}get rpc(){return this.controller.jsonrpcRemote.rpc}async getLastBounds(t,n){try{let r=await this.rpc.getConfig(t,`${Fn}.${n}`);if(r)return JSON.parse(r)}catch(r){B.debug("failed to retrieve bounds for webxdc",r)}return null}setLastBounds(t,n,r){return this.rpc.setConfig(t,`${Fn}.${n}`,JSON.stringify(r))}removeLastBounds(t,n){return this.rpc.setConfig(t,`${Fn}.${n}`,null)}_closeAll(){for(let t of Object.keys(I))I[t].win.close()}};async function ul(e,t){let n=(l,u,h)=>{let m=new Headers;return I[a].internet_access||m.append("Content-Security-Policy",oi),m.append("X-Content-Type-Options","nosniff"),h&&m.append("content-type",h),new Response(l,{...u,headers:m})},r=new URL(t.url),[o,i]=r.hostname.split("."),a=`${o}.${i}`;if(!I[a])return n("",{status:500});let s=r.pathname;s.endsWith("/")&&(s=s.substring(0,s.length-1)),s.startsWith("/")&&(s=s.substring(1));let c=Kr.lookup(s)||"";if(c==="application/pdf"&&(c=void 0),s===ri)return n(await il(le(A(),"/webxdc_wrapper.html")),{},c);if(s==="webxdc.js"){let l=Buffer.from(I[a].displayName).toString("base64"),u=Buffer.from(I[a].selfAddr).toString("base64");return n(Buffer.from(`window.parent.webxdc_internal.setup("${u}","${l}", ${Number(I[a].sendUpdateInterval)}, ${Number(I[a].sendUpdateMaxSize)})
        window.webxdc = window.parent.webxdc
        window.webxdc_custom = window.parent.webxdc_custom`),{},c)}else try{let l=Buffer.from(await e.getWebxdcBlob(I[a].accountId,I[a].msgId,s),"base64");return n(l,{},c)}catch(l){return B.error("webxdc: load blob:",l),n("",{status:404})}}function me(e){for(let t of Object.keys(I)){let n=I[t];if(n.win.webContents===e.sender)return n}return null}function ii(e,t){return`${e.document?je(e.document,32)+" - ":""}${je(e.name,42)} \u2013 ${t}`}function ai(e){return`persist:webxdc_${e}`}function Nt(e){return Jr.fromPartition(ai(e),{cache:!1})}F.handle("webxdc.clearWebxdcDOMStorage",async(e,t)=>{let n=Nt(t);await n.clearStorageData(),await n.clearData()}),F.handle("webxdc.getWebxdcDiskUsage",async(e,t)=>{let n=Nt(t);if(!n.storagePath)throw new Error("session has no storagePath set");let[r,o]=await Promise.all([n.getCacheSize(),si(n.storagePath,["GPUCache","QuotaManager","Code Cache","LOG","LOG.old","LOCK",".DS_Store","Cookies-journal","Databases.db-journal","Preferences","QuotaManager-journal","000003.log","MANIFEST-000001"])]),i=49*1024,a=o-i,s=a-r;return a<0&&(a=0,s=0),{cache_size:r,total_size:a,data_size:s}});async function si(e,t=[]){let n=0;for(let r of await ei(e)){let o=le(e,r),i=await ti(o);t.includes(r)||(i.isDirectory()?n+=await si(o,t):n+=i.size)}return n}async function li(){try{let e=le(J(),"Partitions");if(!al(e))return;let t=await ei(e);for(let n of t)if(n.startsWith("webxdc"))try{await ti(le(e,n,"webxdc-cleanup")),await ol(le(e,n),{recursive:!0}),B.info("webxdc cleanup: deleted ",n)}catch(r){if(r.code!=="ENOENT")throw r}}catch(e){B.warn("webxdc cleanup failed",e)}}function dl(e){let{height:t,width:n}=Qs.getPrimaryDisplay().workAreaSize;return{width:Math.min(e.width,n),height:Math.min(e.height,t)}}F.handle("delete_webxdc_account_data",async(e,t)=>{let n=Jr.fromPartition(`persist:webxdc_${t}`,{cache:!1});if(await n.clearStorageData(),await n.clearData(),n.storagePath)await rl(le(n.storagePath,"webxdc-cleanup"),"-","utf-8");else throw new Error("session has no storagePath set")});f();f();var ie=JSON.parse('{"VERSION":"1.58.2","BUILD_TIMESTAMP":1747636816846,"GIT_REF":"v1.48.0-643-g45833502c"}');import{spawn as fl}from"child_process";import{app as ci,dialog as Bn}from"electron/main";import{arch as pl,platform as ml}from"os";var Ve=x("DC-RPC"),Mt=class{constructor(t,n,r){this.on_data=t;this.accounts_path=n;this.cmd_path=r;this.serverProcess=null}serverProcess;start(){this.serverProcess=fl(this.cmd_path,{env:{DC_ACCOUNTS_PATH:this.accounts_path,RUST_LOG:process.env.RUST_LOG,NO_COLOR:"1"}}),this.serverProcess.on("error",o=>{o.message.endsWith("ENOENT")?Bn.showErrorBox("Fatal Error: Core Library Missing",`The DeltaChat Module is missing! This could be due to your antivirus program. Please check the quarantine to restore it and notify the developers about this issue.
You can reach us on delta@merlinux.eu or on github.com/deltachat/deltachat-desktop/issues.

The missing module should be located at "${this.cmd_path}".

The Log file is located in this folder: ${K()}
--------------------
Error: ${o.message}
`):Bn.showErrorBox("Fatal Error",`Error with core has been detected, please contact developers: You can reach us on delta@merlinux.eu or on github.com/deltachat/deltachat-desktop/issues .

          ${o.name}: ${o.message}

          The Log file is located in this folder: ${K()}

          `),ci.exit(1)});let t="";this.serverProcess.stdout.on("data",o=>{for(t+=o.toString();t.includes(`
`);){let i=t.indexOf(`
`),a=t.substring(0,i);this.on_data(a),t=t.substring(i+1)}});let n="",r=800;this.serverProcess.stderr.on("data",o=>{Ve.error(`stderr: ${o}`.trimEnd()),n=(n+o).slice(-r)}),this.serverProcess.on("close",(o,i)=>{o!==null?Ve.info(`child process close all stdio with code ${o}`):Ve.info(`child process close all stdio with signal ${i}`)}),this.serverProcess.on("exit",(o,i)=>{o!==null?(Ve.info(`child process exited with code ${o}`),o!==0&&(Ve.critical("Fatal: The Delta Chat Core exited unexpectedly",o),Bn.showErrorBox("Fatal Error",`[Version: ${ie.VERSION} | ${ml()} | ${pl()}]
The Delta Chat Core exited unexpectedly with code ${o}
${n}`),ci.exit(1))):Ve.warn(`child process exited with signal ${i}`)})}send(t){this.serverProcess?.stdin.write(t+`
`)}};f();import{startDeltaChat as hl}from"@deltachat/stdio-rpc-server";import{existsSync as Ee,lstatSync as jn}from"fs";import{join as j}from"path";import{mkdir as ui,readdir as di,rename as fi,rm as gl,rmdir as wl,stat as bl}from"fs/promises";async function pi(e,t,n=!1){let r,o=(i,a)=>t.debug("core-event",{accountId:i,...a});try{if(Ee(j(e,"accounts.toml")))return t.debug("migration not needed: accounts.toml already exists"),!1;t.debug("accounts.toml not found, checking if there is previous data");let a=j(e,".."),s=(await di(a)).filter(g=>{let w=j(a,g);try{let D=j(w,"db.sqlite");return jn(w).isDirectory()&&Ee(D)&&jn(D).isFile()&&!jn(w).isSymbolicLink()}catch(D){return t.debug("error while testing if folder is account",D),!1}}),c=s.length!==0,l=Ee(e);if(!c&&!l)return t.info("migration not needed: nothing to migrate"),!1;let u=j(e,"..","accounts"),h=j(e,"..","accounts_old");l&&(t.info("found old some accounts (format 2), we need to migrate..."),await fi(u,h)),r=await hl(u,{muteStdErr:!1}),r.on("ALL",o);let m=[];if(c){t.info(`found old ${s.length} legacy accounts (1), we need to migrate...`);for(let g of s){t.debug(`migrating legacy account "${g}"`);let w=j(a,g,"db.sqlite"),D=j(a,g,"db.sqlite-blobs");Ee(D)||await ui(D,{recursive:!0});try{await r.rpc.migrateAccount(w),m.push(g)}catch(y){if(t.error(`Failed to migrate account at path "${w}"`,y),n)throw y}}}if(l)for(let g of await di(h)){if(!(await bl(j(h,g))).isDirectory())continue;t.debug(`migrating account "${j(h,g)}"`);let D=j(h,g,"db.sqlite");if(!Ee(D)){t.warn("found an old accounts folder without a db.sqlite file, skipping");continue}let y=j(h,g,"db.sqlite-blobs");Ee(y)||await ui(y,{recursive:!0});try{let S=await r.rpc.migrateAccount(D),O=j(h,g,"stickers");if(Ee(O)){t.debug("found stickers, migrating them",O);try{let T=await r.rpc.getBlobDir(S);if(!T)throw new Error("blobdir is undefined");let b=j(T,"../stickers");await fi(O,b)}catch(T){if(t.error("stickers migration failed",O,T),n)throw T}}m.push(j(h,g))}catch(S){t.error(`Failed to migrate account at path "${D}":`,S)}}r.off("ALL",o),r.close();for(let g of m.map(w=>j(a,w)))try{try{await gl(j(g,".DS_Store"))}catch{}await wl(g)}catch(w){t.error("Failed to cleanup old folder:",g,w)}return t.info("migration completed"),!0}catch(i){throw r?.off("ALL",o),r?.close(),i}}import{app as yl,ipcMain as _l}from"electron";import{EventEmitter as vl}from"events";import{yerpc as xl,BaseDeltaChat as El}from"@deltachat/jsonrpc-client";import{getRPCServerPath as Cl}from"@deltachat/stdio-rpc-server";var Tl=yl,Ce=x("main/deltachat"),Rt=x("core/event"),Un=class extends xl.BaseTransport{constructor(n){super();this.sender=n}onMessage(n){this._onmessage(n)}_send(n){this.sender(n)}},Hn=class extends El{},mt=class extends vl{constructor(n){super();this.cwd=n}_inner_account_manager=null;get account_manager(){if(!this._inner_account_manager)throw new Error("account manager is not defined (yet?)");return this._inner_account_manager}rpcServerPath;_jsonrpcRemote=null;get jsonrpcRemote(){if(!this._jsonrpcRemote)throw new Error("_jsonrpcRemote is not defined (yet?)");return this._jsonrpcRemote}async init(){Ce.debug("Check if legacy accounts need migration"),await pi(this.cwd,x("migration"))&&v.update({lastAccount:void 0,lastChats:{},lastSaveDialogLocation:void 0}),Ce.debug("Initiating DeltaChatNode");let n=await Cl({disableEnvPath:!ne["allow-unsafe-core-replacement"]});n.includes("app.asar")&&(n=n.replace("app.asar","app.asar.unpacked")),this.rpcServerPath=n,Ce.info("using deltachat-rpc-server at",{serverPath:n}),this._inner_account_manager=new Mt(o=>{try{if(o.indexOf('"id":"main-')!==-1){let i=JSON.parse(o);if(i.id.startsWith("main-")){i.id=Number(i.id.replace("main-","")),r.onMessage(i);return}}}catch(i){Ce.error("jsonrpc-decode",i)}if($("json-rpc-message",o),o.indexOf("event")!==-1)try{let{result:i}=JSON.parse(o),{contextId:a,event:s}=i;if(a!==void 0&&typeof s=="object"&&s.kind){if(s.kind==="WebxdcRealtimeData")return;if(s.kind==="Warning")Rt.warn(a,s.msg);else if(s.kind==="Info")Rt.info(a,s.msg);else if(s.kind.startsWith("Error"))Rt.error(a,s.msg);else if(Tl.rc["log-debug"]){let c=Object.assign({},s);delete c.kind,Rt.debug(a,s.kind,s)}}}catch{return}},this.cwd,n),this.account_manager.start(),Ce.info("HI");let r=new Un(o=>{o.id=`main-${o.id}`,this.account_manager.send(JSON.stringify(o))});_l.handle("json-rpc-request",(o,i)=>{this.account_manager.send(i)}),this._jsonrpcRemote=new Hn(r,!1),v.state.syncAllAccounts&&(Ce.info("Ready, starting accounts io..."),this.jsonrpcRemote.rpc.startIoForAllAccounts(),Ce.info("Started accounts io."));for(let o of await this.jsonrpcRemote.rpc.getAllAccountIds())this.jsonrpcRemote.rpc.setConfig(o,"verified_one_on_one_chats","1")}webxdc=new pt(this)};import{copyFile as Vn,writeFile as mi,mkdir as Wt,rm as hi}from"fs/promises";import{app as zn,clipboard as Ft,dialog as ht,ipcMain as k,nativeImage as qn,shell as gi,systemPreferences as ze}from"electron";import Dl,{basename as $t,extname as kl,join as ae,posix as Sl,sep as Ol,dirname as wi,normalize as Pl}from"path";import{inspect as Il}from"util";import{platform as Gn}from"os";import{existsSync as Ll}from"fs";import{versions as bi}from"process";import{fileURLToPath as Al}from"url";var hh=wi(Al(import.meta.url)),qe=x("main/ipc"),he=zn,ge;function Gr(){return ge.jsonrpcRemote.rpc}async function yi(e,t){let n=Q;ge=new mt(e);try{await ge.init()}catch(o){qe.critical("Fatal: The DeltaChat Module couldn't be loaded. Please check if all dependencies for deltachat-core are installed!",o,ge.rpcServerPath),console.error("Fatal: The DeltaChat Module couldn't be loaded. Please check if all dependencies for deltachat-core are installed!",o,ge.rpcServerPath),ht.showErrorBox("Fatal Error",`The DeltaChat Module couldn't be loaded.
  Please check if all dependencies for deltachat-core are installed!
  The Log file is located in this folder: ${K()}

  ${ge.rpcServerPath}

  ${o instanceof Error?o.message:Il(o,{depth:null})}`),zn.exit(1)}k.once("ipcReady",o=>{he.ipcReady=!0,he.emit("ipcReady")}),k.on("show",()=>n.show()),k.on("handleLogMessage",(o,i,a,s,...c)=>t.log(i,a,s,...c)),k.on("ondragstart",(o,i)=>{let a;try{if(a=qn.createFromPath(ae(A(),"images/electron-file-drag-out.png")),a.isEmpty())throw new Error("load failed")}catch(s){qe.warn("drag out icon could not be loaded",s);let c=64**2*4,l=Buffer.alloc(c);for(let u=0;u<c;u+=4)l[u]=0,l[u+1]=0,l[u+2]=0,l[u+3]=255;a=qn.createFromBitmap(l,{height:64,width:64})}o.sender.startDrag({file:i,icon:a})}),k.on("help",async(o,i,a)=>{await Pr(i,a)}),k.on("reload-main-window",()=>{if(!d)throw new Error("window does not exist, this should never happen");d.webContents.reload()}),k.on("get-log-path",o=>{o.returnValue=t.logFilePath()}),k.on("get-config-path",o=>{o.returnValue=J().split(Ol).join(Sl.sep)}),k.on("get-rc-config",o=>{o.returnValue=he.rc}),k.on("get-runtime-info",o=>{let i={isMac:Gn()==="darwin",isAppx:Tt,target:"electron",versions:[{label:"electron",value:bi.electron},{label:"node",value:bi.node}],runningUnderARM64Translation:he.runningUnderARM64Translation,rpcServerPath:ge.rpcServerPath,buildInfo:ie,isContentProtectionSupported:Gn()==="darwin"||Gn()==="win32"};o.returnValue=i}),k.on("app-get-path",(o,i)=>{o.returnValue=he.getPath(i)}),k.handle("checkMediaAccess",(o,i)=>{if(!ze.getMediaAccessStatus)return new Promise(a=>{a("unknown")});if(i==="camera")return ze.getMediaAccessStatus("camera");if(i==="microphone")return ze.getMediaAccessStatus("microphone");throw new Error("checkMediaAccess: unsupported media type")}),k.handle("askForMediaAccess",(o,i)=>{if(ze.askForMediaAccess){if(i==="camera")return ze.askForMediaAccess("camera");if(i==="microphone")return ze.askForMediaAccess("microphone")}return new Promise(a=>{a(void 0)})}),k.handle("fileChooser",async(o,i)=>{if(!d)throw new Error("window does not exist, this should never happen");let a=await ht.showOpenDialog(d,i);return d.filePathWhiteList.push(...a.filePaths),a});let r;return k.handle("saveFile",async(o,i,a)=>{if(!d)throw new Error("window does not exist, this should never happen");let s=r||he.getPath("downloads");Ll(s)||(s=he.getPath("downloads"));let{canceled:c,filePath:l}=await ht.showSaveDialog(d,{defaultPath:ae(s,a)});if(!c&&l){try{await Vn(i,l)}catch(u){u.code=="EACCES"?ht.showErrorBox("Permission Error","Cannot write in this folder. You don't have write permission"):ht.showErrorBox("Unhandled Error",`Cannot copy file. Error: ${u}`)}r=Dl.dirname(l)}}),k.handle("get-desktop-settings",async o=>v.state),k.handle("set-desktop-setting",(o,i,a)=>(v.update({[i]:a}),i==="minimizeToTray"?Ct():i==="contentProtectionEnabled"&&fr(!!a),!0)),k.handle("app.setBadgeCountAndTrayIconIndicator",(o,i)=>{he.setBadgeCount(i),ur(i!==0)}),k.handle("app.writeTempFileFromBase64",(o,i,a)=>$n(i,a)),k.handle("app.writeTempFile",(o,i,a)=>Nl(i,a)),k.handle("app.copyFileToInternalTmpDir",(o,i,a)=>Ml(i,a)),k.handle("app.removeTempFile",(o,i)=>Rl(i)),k.handle("electron.shell.openExternal",(o,i)=>gi.openExternal(i)),k.handle("electron.shell.openPath",(o,i)=>gi.openPath(st(i))),k.handle("electron.clipboard.readText",()=>Ft.readText()),k.handle("electron.clipboard.readImage",()=>{let o=Ft.readImage();return o.isEmpty()?null:o.toDataURL()}),k.handle("electron.clipboard.writeText",(o,i)=>Ft.writeText(i)),k.handle("electron.clipboard.writeImage",(o,i)=>Ft.writeImage(qn.createFromPath(i))),k.handle("saveBackgroundImage",async(o,i,a)=>{let s=a?ae(A(),"images/backgrounds/",i):i,c=ae(J(),"background");await hi(c,{recursive:!0,force:!0}),await Wt(c,{recursive:!0});let l=`background_${Date.now()}`+kl(s),u=ae(J(),"background",l);try{await Vn(s,u)}catch(h){throw qe.error("BG-IMG Copy Failed",h),h}return`img: ${l.replace(/\\/g,"/")}`}),k.handle("openMessageHTML",async(o,i,a,s,c,l,u,h)=>{qr(i,a,s,c,l,u,h)}),()=>{ge.jsonrpcRemote.rpc.stopIoForAllAccounts()}}async function $n(e,t){await Wt(de(),{recursive:!0});let n=ae(de(),$t(e));return qe.debug(`Writing base64 encoded file ${n}`),await mi(n,Buffer.from(t,"base64"),"binary"),n}async function Nl(e,t){await Wt(de(),{recursive:!0});let n=ae(de(),$t(e));return qe.debug(`Writing tmp file ${n}`),await mi(n,Buffer.from(t,"utf8"),"binary"),n}async function Ml(e,t){let n=$t(t),r=wi(t);e=$t(Pl(e));let o=ae(r,"..",vt);n!==e&&(o=ae(o,n)),await Wt(o,{recursive:!0});let i=ae(o,e);return await Vn(t,i),i}async function Rl(e){if(e.indexOf(zn.getPath("temp"))===-1||e.indexOf("..")!==-1)throw qe.error("removeTempFile was called with a path that is outside of the temp dir: ",e),new Error("Path is outside of the temp folder");await hi(e)}f();import{platform as _i}from"os";import{app as Fl,Notification as vi,nativeImage as Jn,ipcMain as Ge}from"electron";var Bt=x("main/notifications"),xi=_i()==="darwin";vi.isSupported()?(Ge.handle("notifications.show",jl),Ge.handle("notifications.clear",Ei),Ge.handle("notifications.clearAll",Ci),process.on("beforeExit",Ci)):(Ge.handle("notifications.show",()=>{}),Ge.handle("notifications.clear",()=>{}),Ge.handle("notifications.clearAll",()=>{}));function $l(e){let t=e.icon?e.icon.startsWith("data:")?Jn.createFromDataURL(e.icon):Jn.createFromPath(e.icon):void 0;(!t||t.isEmpty())&&(xi||(t=Jn.createFromPath(ue())));let n={title:e.title,body:_i()==="linux"?Ul(e.body):e.body,icon:t,timeoutType:"default"};return process.platform==="win32"&&(n.closeButtonText=void 0),new vi(n)}function Bl(e,t,n,r){$("ClickOnNotification",{accountId:e,chatId:t,msgId:n}),rt(),Fl.focus(),d?.focus()}var U={};function jl(e,t){let{chatId:n,accountId:r}=t;Bt.debug("Creating notification:",Object.assign({},t,{body:void 0,title:void 0}));try{let o=$l(t);o.on("click",i=>{Bl(t.accountId,n,t.messageId,i),U[r][n]=U[r]?.[n]?.filter(a=>a!==o)||[],o.close()}),o.on("close",()=>{xi&&(U[r][n]=U[r]?.[n]?.filter(i=>i!==o)||[]),console.log("Notification close event triggered",o)}),U[r]||(U[r]={}),U[r][n]?U[r][n].push(o):U[r][n]=[o],o.show()}catch(o){Bt.warn("could not create notification:",o)}}function Ei(e,t,n){if(Bt.debug("clearNotificationsForChat",{accountId:t,chatId:n,notifications:U}),U[t]?.[n]){for(let r of U[t]?.[n]||[])r.close();delete U[t][n]}Bt.debug("after cleared Notifications",{accountId:t,chatId:n,notifications:U})}function Ci(){for(let e of Object.keys(U))if(!Number.isNaN(Number(e)))for(let t of Object.keys(U[Number(e)]))Number.isNaN(Number(t))||Ei(null,Number(e),Number(t))}function Ul(e){return(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}f();import{app as Hl}from"electron";import{mkdir as Vl,readdir as zl,rm as Ti,rmdir as ql}from"fs/promises";import{join as jt}from"path";import{readdirSync as Di}from"fs";var Je=x("main/cleanup_temp_dir");async function Kn(){try{let e=de();if(await Vl(e,{recursive:!0}),e.indexOf(Hl.getPath("temp"))===-1||e.indexOf("..")!==-1)throw Je.error("removeTempFile was called with a path that is outside of the temp dir: ",e),new Error("Path is outside of the temp folder");let t=await zl(e);if(t.length!==0){Je.debug(`found old ${t.length} temporary draft files, trying to delete them now`);let n=[];for(let r of t)Je.debug("delete",jt(e,r)),n.push(Ti(jt(e,r)));await Promise.all(n)}await ql(e)}catch(e){Je.error("Cleanup of old temp files failed: ",e)}}async function ki(){try{let e=0,t=Di(be(),{withFileTypes:!0}).filter(n=>n.isDirectory()).flatMap(n=>Di(jt(n.parentPath,n.name),{withFileTypes:!0}).filter(r=>r.isDirectory()&&r.name===vt));t.length>0&&(e=(await Promise.all(t.map(n=>Ti(jt(n.parentPath,n.name),{recursive:!0,force:!0})))).length),Je.info(`Deleted ${e} internal tmp directories`)}catch(e){Je.error("Cleanup of internal temp dirs failed: ",e)}}console.time("init");import{mkdirSync as Yn,watchFile as Gl}from"fs";import{app as Ut,dialog as Si,ipcMain as Jl,protocol as Kl}from"electron";var Oi="MAP * ~NOTFOUND, EXCLUDE *.openstreetmap.org";Ut.commandLine.appendSwitch("host-resolver-rules",Oi),Ut.commandLine.appendSwitch("host-rules",Oi),Ut.commandLine.appendSwitch("disable-features","IsolateSandboxedIframes"),(ne.version===!0||ne.v===!0)&&(console.info(ie.VERSION),process.exit()),(ne.help===!0||ne.h===!0)&&(Dr(),process.exit()),Kl.registerSchemesAsPrivileged([{scheme:"webxdc",privileges:{secure:!0,allowServiceWorkers:!0,standard:!0,supportFetchAPI:!0,stream:!0}}]);var N=Ut;N.rc=ne,!process.mas&&!N.requestSingleInstanceLock()&&!process.env.DC_TEST_DIR&&(console.error("Only one instance allowed. Quitting."),N.quit(),process.exit(0));Yn(J(),{recursive:!0}),Yn(K(),{recursive:!0}),Yn(nt(),{recursive:!0});var gt=Sr(),M=x("main/index");Po(gt.log,ne),M.info(`Deltachat Version ${ie.VERSION} ${ie.GIT_REF} ${ie.BUILD_TIMESTAMP}`),process.on("exit",gt.end),process.on("uncaughtException",e=>{let t={message:e.message,stack:e.stack};M?M.error("uncaughtError",t):console.error("uncaughtException",t),Si.showErrorBox("Error - uncaughtException",`See the logfile (${gt.logFilePath()}) for details and contact the developers about this issue:
`+JSON.stringify(t))});N.ipcReady=!1,N.isQuitting=!1,Promise.all([new Promise((e,t)=>N.on("ready",e)),v.load(),gr(),li()]).then(Yl).catch(e=>{M.critical("Fatal Error during init",e),Si.showErrorBox("Fatal Error during init",`[Version: ${ie.VERSION} | ${Ql()} | ${Xl()}]]
${e}

Also make sure you are not trying to run multiple instances of deltachat.`),process.exit(1)});var Zn=null;async function Yl([e,t,n,r]){$r(),Pt(v.state.locale||N.getLocale());let o=be();M.info(`cwd ${o}`),Zn=await yi(o,gt),mn({hidden:N.rc.minimized}),vr(gt),ne.devmode&&it(),N.rc["translation-watch"]&&Gl(Zl(We(),"/_untranslated_en.json"),(i,a)=>{i.mtime!==a.mtime&&(M.info("translation-watch: File changed reloading translation data"),at(Fe().locale),M.info("translation-watch: reloading translation data - done"))}),Or().catch(i=>M.error("Cleanup of old logfiles failed: ",i)),Kn(),ki(),kr()}N.once("ipcReady",()=>{if(!d)throw new Error("window does not exist, this should never happen");console.timeEnd("init"),process.env.NODE_ENV==="test"&&d.maximize(),Ct(),d.on("close",e=>{M.debug("mainWindow.window.on('close')"),N.isQuitting||(e.preventDefault(),N.rc.minimized||v.state.minimizeToTray?(M.debug("mainWindow.window.on('close') Hiding main window"),Ne()):process.platform==="darwin"?(M.debug("mainWindow.window.on('close') We are on mac, so lets hide the main window"),Ne()):(M.debug("mainWindow.window.on('close') Quitting deltachat"),Xn(e)))})});function Xn(e){if(N.isQuitting)return;N.isQuitting=!0,e?.preventDefault(),M.info("Starting app shutdown process");try{d?.close(),d?.destroy()}catch(n){M.error("failed to close window, error:",n)}Zn&&Zn(),Kn();function t(){M.info("Quitting now. Bye."),N.quit()}v.saveImmediate().then(()=>{setTimeout(t,500)}),setTimeout(()=>{M.error("Saving state took too long. Quitting."),t()},4e3)}N.on("activate",()=>{if(M.debug("app.on('activate')"),!d){M.warn("window not set, this is normal on startup");return}d.isVisible()===!1?(M.debug("app.on('activate') showing main window"),ye()):M.debug("app.on('activate') mainWindow is visible, no need to show it")}),N.on("before-quit",e=>Xn(e)),N.on("window-all-closed",()=>Xn()),N.on("web-contents-created",(e,t)=>{if(t.session.storagePath&&t.session.storagePath.indexOf("webxdc_")!==-1){let r=o=>{(o.startsWith("mailto:")||o.startsWith("openpgp4fpr:"))&&(Ue(o),d?.show())};t.on("will-navigate",(o,i)=>{i.startsWith("webxdc://")||(i.startsWith("mailto:")?(o.preventDefault(),r(i)):o.preventDefault())}),t.on("will-frame-navigate",o=>{o.url.startsWith("webxdc://")||(o.url.startsWith("mailto:")?(o.preventDefault(),r(o.url)):o.preventDefault())}),t.setWindowOpenHandler(o=>(r(o.url),{action:"deny"}))}else t.on("will-navigate",(r,o)=>{M.warn("blocked navigation attempt to",o),r.preventDefault()}),t.setWindowOpenHandler(r=>({action:"deny"}));t.on("will-attach-webview",(r,o,i)=>{r.preventDefault()})}),Tr();import{join as Zl}from"path";import{arch as Xl,platform as Ql}from"os";On(process.argv),Jl.handle("restart_app",async e=>{N.relaunch(),N.quit()});export{Xn as quit};
/*! Bundled license information:

deep-extend/lib/deep-extend.js:
  (*!
   * @description Recursive object extending
   * @author Viacheslav Lotsmanov <lotsmanov89@gmail.com>
   * @license MIT
   *
   * The MIT License (MIT)
   *
   * Copyright (c) 2013-2018 Viacheslav Lotsmanov
   *
   * Permission is hereby granted, free of charge, to any person obtaining a copy of
   * this software and associated documentation files (the "Software"), to deal in
   * the Software without restriction, including without limitation the rights to
   * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
   * the Software, and to permit persons to whom the Software is furnished to do so,
   * subject to the following conditions:
   *
   * The above copyright notice and this permission notice shall be included in all
   * copies or substantial portions of the Software.
   *
   * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
   * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
   * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
   * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
   * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
   *)
*/
//# sourceMappingURL=index.js.map
